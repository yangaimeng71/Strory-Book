<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üé® AIÁªòÊú¨ - ÂÑøÁ´•ÊïÖ‰∫ãÁîüÊàêÂô®</title>
    <meta name="description" content="‰∏∫3-8Â≤ÅÂÑøÁ´•ËÆæËÆ°ÁöÑAIÁªòÊú¨Âàõ‰ΩúÂ∑•ÂÖ∑ÔºåÊîØÊåÅÂ§ßÊ®°ÂûãÊïÖ‰∫ãÁîüÊàê„ÄÅÊèíÁîªÈÖçÂõæÂíåËØ≠Èü≥ÊúóËØª">
    <meta name="keywords" content="AIÁªòÊú¨,ÂÑøÁ´•ÊïÖ‰∫ã,ËØ≠Èü≥ÊúóËØª,ÁßªÂä®Á´Ø,ÊïôËÇ≤,Â§ßÊ®°Âûã">
    
    <!-- Ê∑ªÂä†PWAÊîØÊåÅ -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQUnnu5jmnKwiLCJzaG9ydF9uYW1lIjoiQUnnu5jmnKwiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiM2NjdlZWEiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBNU5pQTVOaUlnZG1WeWMybHZiajBpTVM0eElpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTVoY21jdk1qQXdNQzl6ZG1jaVBnbzhZMmx5WTJ4bElHTjRQU0kwT0NJZ1kza1BTSDBPV0NJZ2NqMGlNemt1TmlJZ1ptbHNiRDBpSXpZMk4yVmxZU0lnTHo0OGRHVjRkQ0I0UFNJek5pSWdlVDBpTlRRaUlHWnZiblF0Wm1GdGFXeDVQU0pCY21saGJDSWdabTl1ZEMxemFYcGxQU0l6TUhCNElpQm1hV3hzUFNJalptWm1JaUErOEFvZ1FVa080NGEvYStlN21PZStpVGdnUEM5MFpYaDBQZzhMM04yWnoiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        /* Âü∫Á°ÄÊ†∑ÂºèÈáçÁΩÆ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
        }

        /* È°µÈù¢ÂÆπÂô® */
        .page {
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* È¶ñÈ°µÊ†∑Âºè */
        #homePage {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .header {
            margin-bottom: 40px;
            position: relative;
        }

        .settings-btn {
            position: absolute;
            top: -10px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .settings-btn:hover, .settings-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }

        .logo {
            font-size: 2.8rem;
            color: #fff;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .subtitle {
            color: #fff;
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 35px 30px;
            margin-bottom: 30px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .input-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.2);
        }

        .input-section h2 {
            color: #5a67d8;
            margin-bottom: 25px;
            font-size: 1.4rem;
            font-weight: 600;
        }

        #storyInput {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1.05rem;
            margin-bottom: 25px;
            background: #fff;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #storyInput:focus {
            outline: none;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }

        .primary-btn {
            width: 100%;
            padding: 18px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.15rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
            font-family: inherit;
        }

        .primary-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .primary-btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .preset-themes {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px);
        }

        .preset-themes h3 {
            color: #5a67d8;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .theme-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .theme-tag {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #fff;
            padding: 12px 18px;
            border-radius: 28px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .theme-tag:hover, .theme-tag:active {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 154, 158, 0.4);
        }

        /* Âä†ËΩΩÈ°µÊ†∑Âºè */
        #loadingPage {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .loading-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 45px 35px;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            max-width: 400px;
            width: 100%;
        }

        .magic-wand {
            font-size: 3.5rem;
            animation: sparkle 2s ease-in-out infinite;
            margin-bottom: 25px;
            position: relative;
        }

        .magic-wand:after {
            content: '‚ú®';
            position: absolute;
            top: -10px;
            right: -15px;
            font-size: 1.5rem;
            animation: twinkle 1.5s ease-in-out infinite alternate;
        }

        @keyframes sparkle {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(12deg) scale(1.1); }
            75% { transform: rotate(-12deg) scale(1.1); }
        }

        @keyframes twinkle {
            0% { opacity: 0.5; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .loading-text {
            font-size: 1.3rem;
            color: #5a67d8;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .step {
            padding: 14px 22px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            color: #5a67d8;
            font-weight: 600;
            opacity: 0.6;
            transition: all 0.4s ease;
            border-left: 4px solid transparent;
        }

        .step.active {
            opacity: 1;
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(8px);
            border-left-color: #667eea;
        }

        /* APIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: #5a67d8;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #a0aec0;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: #5a67d8;
            background: rgba(90, 103, 216, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .form-help {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }

        .api-status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .api-status.success {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }

        .api-status.error {
            background: rgba(245, 101, 101, 0.1);
            color: #e53e3e;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }

        .api-status.warning {
            background: rgba(237, 137, 54, 0.1);
            color: #dd6b20;
            border: 1px solid rgba(237, 137, 54, 0.3);
        }

        /* ÊïÖ‰∫ãÈòÖËØªÈ°µÂíåÂÖ∂‰ªñÈ°µÈù¢Ê†∑Âºè‰øùÊåÅ‰∏çÂèò... */
        
        /* ÊïÖ‰∫ãÈòÖËØªÈ°µÊ†∑Âºè */
        #storyPage {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 0;
        }

        .story-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .icon-btn {
            background: rgba(90, 103, 216, 0.1);
            border: none;
            font-size: 1.8rem;
            color: #5a67d8;
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .icon-btn:hover, .icon-btn:active {
            background: rgba(90, 103, 216, 0.2);
            transform: scale(1.1);
        }

        #storyTitle {
            font-size: 1.3rem;
            color: #5a67d8;
            font-weight: 700;
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }

        .page-indicator {
            font-size: 1rem;
            color: #667eea;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
        }

        .story-content {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .story-image {
            position: relative;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            aspect-ratio: 4/3;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
            background: linear-gradient(45deg, #f0f2f5 25%, #e2e8f0 50%, #f0f2f5 75%);
            background-size: 400% 400%;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .story-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            transition: all 0.5s ease-in-out;
        }

        .image-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-loading p {
            color: #667eea;
            font-weight: 600;
            font-size: 1rem;
        }

        .story-text {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px);
        }

        #storyParagraph {
            font-size: 1.15rem;
            line-height: 1.9;
            color: #4a5568;
            text-align: justify;
            font-weight: 400;
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 3px 6px;
            border-radius: 6px;
            animation: glow 1s ease-in-out infinite alternate;
            position: relative;
            box-shadow: 0 2px 8px rgba(168, 237, 234, 0.4);
        }

        @keyframes glow {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.02); }
        }

        .control-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 18px;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 14px 18px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            min-width: 85px;
            font-family: inherit;
        }

        .nav-btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .nav-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 18px;
            flex: 1;
            justify-content: center;
        }

        .play-btn {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(255, 154, 158, 0.3);
        }

        .play-btn:hover, .play-btn:active {
            transform: scale(1.15);
            box-shadow: 0 8px 30px rgba(255, 154, 158, 0.5);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            color: #5a67d8;
            font-weight: 600;
        }

        #speedSelect {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.85rem;
            background: white;
            color: #4a5568;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #speedSelect:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ÁªìÊùüÈ°µÊ†∑Âºè */
        #endPage {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .end-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 45px 35px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
            max-width: 420px;
            width: 100%;
        }

        .celebration {
            font-size: 4.5rem;
            animation: bounce 2s ease-in-out infinite;
            margin-bottom: 25px;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-25px); }
            60% { transform: translateY(-12px); }
        }

        .end-container h2 {
            color: #5a67d8;
            font-size: 1.6rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .end-container p {
            color: #667eea;
            font-size: 1.05rem;
            margin-bottom: 35px;
            opacity: 0.9;
            font-weight: 500;
        }

        .end-actions {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .secondary-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #5a67d8;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 14px;
            padding: 14px 24px;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 600;
            font-family: inherit;
        }

        .secondary-btn:hover, .secondary-btn:active {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        /* ToastÊèêÁ§∫ */
        .toast {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 14px 24px;
            border-radius: 30px;
            font-size: 0.95rem;
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 600;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(15px);
        }

        /* ÈöêËóèÂÖ∂‰ªñÈ°µÈù¢ */
        .page:not(#homePage) {
            display: none;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 480px) {
            .page { padding: 18px; }
            .logo { font-size: 2.3rem; }
            .input-section { padding: 28px 22px; }
            .preset-themes { padding: 25px; }
            .story-content { padding: 18px; }
            .control-bar { padding: 20px; gap: 15px; }
            .nav-btn { padding: 12px 15px; font-size: 0.85rem; min-width: 75px; }
            .play-btn { width: 50px; height: 50px; font-size: 1.1rem; }
            .audio-controls { gap: 15px; }
            .modal-content { padding: 25px; }
        }

        @media (max-width: 360px) {
            .theme-tags { gap: 10px; }
            .theme-tag { padding: 10px 14px; font-size: 0.85rem; }
            .control-bar { 
                flex-direction: column; 
                gap: 18px; 
                padding: 18px;
            }
            .nav-btn { 
                width: 100%; 
                justify-content: center;
                min-width: unset;
            }
            .audio-controls {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- È¶ñÈ°µ -->
    <div class="page" id="homePage">
        <div class="header">
            <button id="settingsBtn" class="settings-btn" title="AIËÆæÁΩÆ">‚öôÔ∏è</button>
            <h1 class="logo">üé® AIÁªòÊú¨</h1>
            <p class="subtitle">‰∏∫Â≠©Â≠êÂàõÈÄ†Êó†ÈôêÊÉ≥Ë±°ÁöÑÊïÖ‰∫ã‰∏ñÁïå</p>
        </div>
        
        <div class="input-section">
            <h2>ÂëäËØâÊàë‰Ω†ÊÉ≥Âê¨‰ªÄ‰πàÊïÖ‰∫ãÔºü</h2>
            <input type="text" id="storyInput" placeholder="‰æãÂ¶ÇÔºöÂãáÊï¢ÁöÑÂ∞èÂÖîÂ≠ê" maxlength="50" autocomplete="off">
            <button id="generateBtn" class="primary-btn" title="ÂºÄÂßãÂàõ‰ΩúÊïÖ‰∫ã">
                ‚ú® ÂºÄÂßãÂàõ‰ΩúÊïÖ‰∫ã
            </button>
        </div>
        
        <div class="preset-themes">
            <h3>ÊàñËÄÖÈÄâÊã©‰∏Ä‰∏™‰∏ªÈ¢òÔºö</h3>
            <div class="theme-tags">
                <span class="theme-tag" data-theme="ÂãáÊï¢ÁöÑÂ∞èÂä®Áâ©" title="ÁÇπÂáªÈÄâÊã©">üê∞ ÂãáÊï¢Â∞èÂä®Áâ©</span>
                <span class="theme-tag" data-theme="Á•ûÂ•áÁöÑÊ£ÆÊûó" title="ÁÇπÂáªÈÄâÊã©">üå≤ Á•ûÂ•áÊ£ÆÊûó</span>
                <span class="theme-tag" data-theme="ÂèãË∞äÁöÑÂäõÈáè" title="ÁÇπÂáªÈÄâÊã©">üë´ ÂèãË∞äÊïÖ‰∫ã</span>
                <span class="theme-tag" data-theme="Â•áÂ¶ôÁöÑÊµ∑Â∫ï‰∏ñÁïå" title="ÁÇπÂáªÈÄâÊã©">üê† Êµ∑Â∫ï‰∏ñÁïå</span>
                <span class="theme-tag" data-theme="Â§™Á©∫Â§ßÂÜíÈô©" title="ÁÇπÂáªÈÄâÊã©">üöÄ Â§™Á©∫ÂÜíÈô©</span>
                <span class="theme-tag" data-theme="ÂñÑËâØÁöÑÂ∞èÂÖ¨‰∏ª" title="ÁÇπÂáªÈÄâÊã©">üë∏ Á´•ËØùÂÖ¨‰∏ª</span>
            </div>
        </div>
    </div>
    
    <!-- Âä†ËΩΩÈ°µ -->
    <div class="page" id="loadingPage">
        <div class="loading-container">
            <div class="magic-wand" role="img" aria-label="È≠îÊ≥ïÊ£í">‚ú®</div>
            <div class="loading-text">AIÊ≠£Âú®‰∏∫‰Ω†Âàõ‰ΩúÊïÖ‰∫ã...</div>
            <div class="loading-steps">
                <div class="step" id="step1">ü§ñ Â§ßÊ®°ÂûãÊûÑÊÄùÊïÖ‰∫ãÊÉÖËäÇ</div>
                <div class="step" id="step2">üé® AIÁªòÂà∂Á≤æÁæéÊèíÁîª</div>
                <div class="step" id="step3">üéµ ÂáÜÂ§áËØ≠Èü≥ÊúóËØª</div>
            </div>
        </div>
    </div>
    
    <!-- ÊïÖ‰∫ãÈòÖËØªÈ°µ -->
    <div class="page" id="storyPage">
        <div class="story-header">
            <button id="backBtn" class="icon-btn" title="ËøîÂõûÈ¶ñÈ°µ" aria-label="ËøîÂõûÈ¶ñÈ°µ">‚Üê</button>
            <h2 id="storyTitle">ÊïÖ‰∫ãÊ†áÈ¢ò</h2>
            <div class="page-indicator" role="status" aria-live="polite">
                <span id="currentPage">1</span> / <span id="totalPages">1</span>
            </div>
        </div>
        
        <div class="story-content">
            <div class="story-image">
                <img id="storyImg" src="" alt="ÊïÖ‰∫ãÊèíÁîª" style="display: none;">
                <div class="image-loading" id="imageLoading" role="status" aria-live="polite">
                    <div class="spinner" aria-label="Âä†ËΩΩ‰∏≠"></div>
                    <p>Ê≠£Âú®ÁªòÂà∂ÊèíÁîª...</p>
                </div>
            </div>
            
            <div class="story-text">
                <p id="storyParagraph" role="main"></p>
            </div>
        </div>
        
        <div class="control-bar" role="toolbar" aria-label="ÊïÖ‰∫ãÊéßÂà∂">
            <button id="prevBtn" class="nav-btn" disabled title="‰∏ä‰∏ÄÈ°µ" aria-label="‰∏ä‰∏ÄÈ°µ">
                ‚Üê ‰∏ä‰∏ÄÈ°µ
            </button>
            
            <div class="audio-controls">
                <button id="playBtn" class="play-btn" title="Êí≠Êîæ/ÊöÇÂÅú" aria-label="Êí≠ÊîæÊúóËØª">‚ñ∂Ô∏è</button>
                <div class="speed-control">
                    <label for="speedSelect">ËØ≠ÈÄü:</label>
                    <select id="speedSelect" title="ÈÄâÊã©ÊúóËØªËØ≠ÈÄü">
                        <option value="0.8">ÊÖ¢</option>
                        <option value="1.0" selected>Ê≠£Â∏∏</option>
                        <option value="1.2">Âø´</option>
                    </select>
                </div>
            </div>
            
            <button id="nextBtn" class="nav-btn" title="‰∏ã‰∏ÄÈ°µ" aria-label="‰∏ã‰∏ÄÈ°µ">
                ‰∏ã‰∏ÄÈ°µ ‚Üí
            </button>
        </div>
    </div>
    
    <!-- ÁªìÊùüÈ°µ -->
    <div class="page" id="endPage">
        <div class="end-container">
            <div class="celebration" role="img" aria-label="Â∫ÜÁ•ù">üéâ</div>
            <h2>ÊïÖ‰∫ãÁªìÊùüÂï¶ÔºÅ</h2>
            <p>Â∏åÊúõ‰Ω†ÂñúÊ¨¢Ëøô‰∏™ÁæéÂ¶ôÁöÑÊïÖ‰∫ãÔΩû</p>
            
            <div class="end-actions">
                <button id="newStoryBtn" class="primary-btn" title="Âàõ‰ΩúÊñ∞ÊïÖ‰∫ã">
                    ‚ú® ÂÜçÊù•‰∏Ä‰∏™ÊïÖ‰∫ã
                </button>
                <button id="saveStoryBtn" class="secondary-btn" title="‰øùÂ≠òÂà∞Êú¨Âú∞">
                    üìñ ‰øùÂ≠òÊïÖ‰∫ã
                </button>
                <button id="shareStoryBtn" class="secondary-btn" title="ÂàÜ‰∫´ÁªôÊúãÂèã">
                    üì§ ÂàÜ‰∫´ÁªòÊú¨
                </button>
            </div>
        </div>
    </div>

    <!-- APIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div id="apiConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ü§ñ AIÂ§ßÊ®°ÂûãÈÖçÁΩÆ</h3>
                <button id="closeApiConfigBtn" class="close-btn">√ó</button>
            </div>
            
            <div id="apiStatus" class="api-status warning">
                ‚ö†Ô∏è ËØ∑ÈÖçÁΩÆAIÊé•Âè£‰ª•ÂêØÁî®Êô∫ËÉΩÊïÖ‰∫ãÁîüÊàêÂäüËÉΩ
            </div>
            
            <form id="apiConfigForm">
                <div class="form-group">
                    <label for="apiUrl">API Êé•Âè£Âú∞ÂùÄ</label>
                    <input type="url" id="apiUrl" value="https://ark.cn-beijing.volces.com/api/v3/chat/completions" placeholder="https://api.example.com/v1/chat/completions">
                    <div class="form-help">Â°´ÂÖ•ÊÇ®ÁöÑÂ§ßÊ®°ÂûãAPIÊé•Âè£Âú∞ÂùÄ</div>
                </div>
                
                <div class="form-group">
                    <label for="apiKey">API ÂØÜÈí•</label>
                    <input type="password" id="apiKey" value="893b9f2c-3b3c-4943-a482-5ab6dde65007" placeholder="sk-...">
                    <div class="form-help">ÊÇ®ÁöÑAPIËÆøÈóÆÂØÜÈí•ÔºåÂ∞ÜÂÆâÂÖ®Â≠òÂÇ®Âú®Êú¨Âú∞</div>
                </div>
                
                <div class="form-group">
                    <label for="modelName">Ê®°ÂûãÂêçÁß∞</label>
                    <input type="text" id="modelName" value="doubao-1-5-pro-32k-250115" placeholder="gpt-3.5-turbo">
                    <div class="form-help">‰ΩøÁî®ÁöÑÂ§ßÊ®°ÂûãÂêçÁß∞</div>
                </div>
                
                <div class="form-group">
                    <label for="systemPrompt">ÊïÖ‰∫ãÁîüÊàêÊèêÁ§∫ËØç</label>
                    <textarea id="systemPrompt" placeholder="ËØ∑‰∏∫ÂÑøÁ´•Âàõ‰ΩúÊïÖ‰∫ã...">‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÂÑøÁ´•ÊïÖ‰∫ã‰ΩúÂÆ∂ÔºåÊìÖÈïø‰∏∫3-8Â≤ÅÁöÑÂ≠©Â≠êÂàõ‰ΩúÊ∏©È¶®„ÄÅÊúâË∂£„ÄÅÂØåÊúâÊïôËÇ≤ÊÑè‰πâÁöÑÊïÖ‰∫ã„ÄÇËØ∑Ê†πÊçÆÁî®Êà∑Êèê‰æõÁöÑ‰∏ªÈ¢òÔºåÂàõ‰Ωú‰∏Ä‰∏™ÂÆåÊï¥ÁöÑÂÑøÁ´•ÊïÖ‰∫ã„ÄÇ

Ë¶ÅÊ±ÇÔºö
1. ÊïÖ‰∫ãË¶ÅÂàÜ‰∏∫6‰∏™ÊÆµËêΩÔºåÊØè‰∏™ÊÆµËêΩ100-150Â≠ó
2. ËØ≠Ë®ÄË¶ÅÁÆÄÂçïÊòìÊáÇÔºåÈÄÇÂêàÂÑøÁ´•ÁêÜËß£
3. ÊÉÖËäÇË¶ÅÁîüÂä®ÊúâË∂£ÔºåÂØåÊúâÊÉ≥Ë±°Âäõ
4. Ë¶Å‰º†ÈÄíÊ≠£Èù¢ÁöÑ‰ª∑ÂÄºËßÇÔºåÂ¶ÇÂãáÊï¢„ÄÅÂèãË∞ä„ÄÅÂñÑËâØÁ≠â
5. ÈÅøÂÖç‰ªª‰ΩïÂèØËÉΩÂêìÂà∞Â≠©Â≠êÁöÑÂÜÖÂÆπ
6. ÁªìÂ∞æË¶ÅÊ∏©ÊöñÁßØÊûÅ

ËØ∑Áõ¥Êé•ËøîÂõûÊïÖ‰∫ãÂÜÖÂÆπÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
Ê†áÈ¢òÔºö[ÊïÖ‰∫ãÊ†áÈ¢ò]

Á¨¨‰∏ÄÊÆµÔºö[ÂÜÖÂÆπ]
Á¨¨‰∫åÊÆµÔºö[ÂÜÖÂÆπ]
Á¨¨‰∏âÊÆµÔºö[ÂÜÖÂÆπ]
Á¨¨ÂõõÊÆµÔºö[ÂÜÖÂÆπ]
Á¨¨‰∫îÊÆµÔºö[ÂÜÖÂÆπ]
Á¨¨ÂÖ≠ÊÆµÔºö[ÂÜÖÂÆπ]</textarea>
                    <div class="form-help">ÂÆöÂà∂AIÁîüÊàêÊïÖ‰∫ãÁöÑÈ£éÊ†ºÂíåË¶ÅÊ±Ç</div>
                </div>
                
                <div class="form-group">
                    <button type="button" id="testApiBtn" class="secondary-btn">
                        üß™ ÊµãËØïËøûÊé•
                    </button>
                    <button type="submit" class="primary-btn">
                        üíæ ‰øùÂ≠òÈÖçÁΩÆ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ToastÊèêÁ§∫ -->
    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>
    
    <script>
        'use strict';

        // AIÁªòÊú¨Â∫îÁî®‰∏ªÁ±ª
        class StoryApp {
            constructor() {
                this.currentStory = null;
                this.currentPageIndex = 0;
                this.isPlaying = false;
                this.speechSynthesis = window.speechSynthesis;
                this.currentUtterance = null;
                this.highlightTimeout = null;
                this.loadingInterval = null;
                
                // APIÈÖçÁΩÆ
                this.apiConfig = {
                    url: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
                    key: '893b9f2c-3b3c-4943-a482-5ab6dde65007',
                    model: 'doubao-1-5-pro-32k-250115',
                    systemPrompt: '‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÂÑøÁ´•ÊïÖ‰∫ã‰ΩúÂÆ∂ÔºåÊìÖÈïø‰∏∫3-8Â≤ÅÁöÑÂ≠©Â≠êÂàõ‰ΩúÊ∏©È¶®„ÄÅÊúâË∂£„ÄÅÂØåÊúâÊïôËÇ≤ÊÑè‰πâÁöÑÊïÖ‰∫ã„ÄÇËØ∑Ê†πÊçÆÁî®Êà∑Êèê‰æõÁöÑ‰∏ªÈ¢òÔºåÂàõ‰Ωú‰∏Ä‰∏™ÂÆåÊï¥ÁöÑÂÑøÁ´•ÊïÖ‰∫ã„ÄÇ\n\nË¶ÅÊ±ÇÔºö\n1. ÊïÖ‰∫ãË¶ÅÂàÜ‰∏∫6‰∏™ÊÆµËêΩÔºåÊØè‰∏™ÊÆµËêΩ100-150Â≠ó\n2. ËØ≠Ë®ÄË¶ÅÁÆÄÂçïÊòìÊáÇÔºåÈÄÇÂêàÂÑøÁ´•ÁêÜËß£\n3. ÊÉÖËäÇË¶ÅÁîüÂä®ÊúâË∂£ÔºåÂØåÊúâÊÉ≥Ë±°Âäõ\n4. Ë¶Å‰º†ÈÄíÊ≠£Èù¢ÁöÑ‰ª∑ÂÄºËßÇÔºåÂ¶ÇÂãáÊï¢„ÄÅÂèãË∞ä„ÄÅÂñÑËâØÁ≠â\n5. ÈÅøÂÖç‰ªª‰ΩïÂèØËÉΩÂêìÂà∞Â≠©Â≠êÁöÑÂÜÖÂÆπ\n6. ÁªìÂ∞æË¶ÅÊ∏©ÊöñÁßØÊûÅ\n\nËØ∑Áõ¥Êé•ËøîÂõûÊïÖ‰∫ãÂÜÖÂÆπÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö\nÊ†áÈ¢òÔºö[ÊïÖ‰∫ãÊ†áÈ¢ò]\n\nÁ¨¨‰∏ÄÊÆµÔºö[ÂÜÖÂÆπ]\nÁ¨¨‰∫åÊÆµÔºö[ÂÜÖÂÆπ]\nÁ¨¨‰∏âÊÆµÔºö[ÂÜÖÂÆπ]\nÁ¨¨ÂõõÊÆµÔºö[ÂÜÖÂÆπ]\nÁ¨¨‰∫îÊÆµÔºö[ÂÜÖÂÆπ]\nÁ¨¨ÂÖ≠ÊÆµÔºö[ÂÜÖÂÆπ]'
                };
                
                this.init();
            }

            init() {
                console.log('üé® AIÁªòÊú¨Â∫îÁî®ÂêØÂä® v3.0 - Â§ßÊ®°ÂûãÁâà');
                try {
                    this.loadApiConfig();
                    this.bindEvents();
                    this.showPage('homePage');
                    this.showToast('‚ú® Ê¨¢Ëøé‰ΩøÁî®AIÁªòÊú¨ÔºÅÂ∑≤ÈõÜÊàêÂ§ßÊ®°ÂûãÊïÖ‰∫ãÁîüÊàê');
                    this.preloadVoices();
                    this.updateApiStatus();
                } catch (error) {
                    console.error('‚ùå Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    this.showToast('Â∫îÁî®Âä†ËΩΩÂá∫ÈîôÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                }
            }

            loadApiConfig() {
                try {
                    const saved = localStorage.getItem('aiStorybook_apiConfig');
                    if (saved) {
                        this.apiConfig = { ...this.apiConfig, ...JSON.parse(saved) };
                        console.log('üì• Â∑≤Âä†ËΩΩAPIÈÖçÁΩÆ');
                    }
                } catch (error) {
                    console.error('‚ùå Âä†ËΩΩAPIÈÖçÁΩÆÂ§±Ë¥•:', error);
                }
            }

            saveApiConfig() {
                try {
                    localStorage.setItem('aiStorybook_apiConfig', JSON.stringify(this.apiConfig));
                    console.log('üíæ APIÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');
                } catch (error) {
                    console.error('‚ùå ‰øùÂ≠òAPIÈÖçÁΩÆÂ§±Ë¥•:', error);
                }
            }

            updateApiStatus() {
                const statusEl = document.getElementById('apiStatus');
                if (!statusEl) return;

                if (this.apiConfig.key && this.apiConfig.url) {
                    statusEl.className = 'api-status success';
                    statusEl.textContent = '‚úÖ AIÊé•Âè£Â∑≤ÈÖçÁΩÆÔºåÂèØ‰ª•‰ΩøÁî®Êô∫ËÉΩÊïÖ‰∫ãÁîüÊàêÂäüËÉΩ';
                } else {
                    statusEl.className = 'api-status warning';
                    statusEl.textContent = '‚ö†Ô∏è ËØ∑ÈÖçÁΩÆAIÊé•Âè£‰ª•ÂêØÁî®Êô∫ËÉΩÊïÖ‰∫ãÁîüÊàêÂäüËÉΩ';
                }
            }

            preloadVoices() {
                if (this.speechSynthesis) {
                    this.speechSynthesis.getVoices();
                    this.speechSynthesis.onvoiceschanged = () => {
                        console.log('üéµ ËØ≠Èü≥Â∫ìÂä†ËΩΩÂÆåÊàê');
                    };
                }
            }

            bindEvents() {
                // È¶ñÈ°µ‰∫ã‰ª∂
                const generateBtn = document.getElementById('generateBtn');
                const storyInput = document.getElementById('storyInput');
                
                if (generateBtn) {
                    generateBtn.addEventListener('click', () => this.generateStory());
                }

                if (storyInput) {
                    storyInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.generateStory();
                        }
                    });

                    storyInput.addEventListener('focus', () => {
                        storyInput.select();
                    });
                }

                // ‰∏ªÈ¢òÊ†áÁ≠æÁÇπÂáª
                document.querySelectorAll('.theme-tag').forEach(tag => {
                    tag.addEventListener('click', () => {
                        const theme = tag.dataset.theme;
                        if (storyInput) storyInput.value = theme;
                        this.generateStory();
                    });
                });

                // ÊïÖ‰∫ãÈ°µÈù¢‰∫ã‰ª∂
                const backBtn = document.getElementById('backBtn');
                if (backBtn) {
                    backBtn.addEventListener('click', () => this.goHome());
                }

                const prevBtn = document.getElementById('prevBtn');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => this.previousPage());
                }

                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => this.nextPage());
                }

                const playBtn = document.getElementById('playBtn');
                if (playBtn) {
                    playBtn.addEventListener('click', () => this.togglePlayback());
                }

                const speedSelect = document.getElementById('speedSelect');
                if (speedSelect) {
                    speedSelect.addEventListener('change', () => this.stopPlayback());
                }

                // ÁªìÊùüÈ°µÈù¢‰∫ã‰ª∂
                const newStoryBtn = document.getElementById('newStoryBtn');
                if (newStoryBtn) {
                    newStoryBtn.addEventListener('click', () => this.goHome());
                }

                const saveStoryBtn = document.getElementById('saveStoryBtn');
                if (saveStoryBtn) {
                    saveStoryBtn.addEventListener('click', () => this.saveStory());
                }

                const shareStoryBtn = document.getElementById('shareStoryBtn');
                if (shareStoryBtn) {
                    shareStoryBtn.addEventListener('click', () => this.shareStory());
                }

                // ËÆæÁΩÆÊåâÈíÆ - ÊâìÂºÄAPIÈÖçÁΩÆ
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => this.showApiConfig());
                }

                // APIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
                this.bindApiConfigEvents();

                // ÈîÆÁõòÂø´Êç∑ÈîÆ
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.stopPlayback();
                        this.hideApiConfig();
                    }
                });

                console.log('‚úÖ ÊâÄÊúâ‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö');
            }

            bindApiConfigEvents() {
                const modal = document.getElementById('apiConfigModal');
                const closeBtn = document.getElementById('closeApiConfigBtn');
                const form = document.getElementById('apiConfigForm');
                const testBtn = document.getElementById('testApiBtn');

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideApiConfig());
                }

                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.hideApiConfig();
                        }
                    });
                }

                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveApiConfigFromForm();
                    });
                }

                if (testBtn) {
                    testBtn.addEventListener('click', () => this.testApiConnection());
                }
            }

            showApiConfig() {
                const modal = document.getElementById('apiConfigModal');
                if (!modal) return;

                // Â°´ÂÖÖÂΩìÂâçÈÖçÁΩÆ
                document.getElementById('apiUrl').value = this.apiConfig.url || '';
                document.getElementById('apiKey').value = this.apiConfig.key || '';
                document.getElementById('modelName').value = this.apiConfig.model || '';
                document.getElementById('systemPrompt').value = this.apiConfig.systemPrompt || '';

                modal.style.display = 'flex';
                this.updateApiStatus();
            }

            hideApiConfig() {
                const modal = document.getElementById('apiConfigModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            saveApiConfigFromForm() {
                this.apiConfig = {
                    url: document.getElementById('apiUrl').value.trim(),
                    key: document.getElementById('apiKey').value.trim(),
                    model: document.getElementById('modelName').value.trim(),
                    systemPrompt: document.getElementById('systemPrompt').value.trim()
                };

                this.saveApiConfig();
                this.updateApiStatus();
                this.hideApiConfig();
                this.showToast('üíæ APIÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');
            }

            async testApiConnection() {
                const testBtn = document.getElementById('testApiBtn');
                if (!testBtn) return;

                testBtn.disabled = true;
                testBtn.textContent = 'üß™ ÊµãËØï‰∏≠...';

                try {
                    const tempConfig = {
                        url: document.getElementById('apiUrl').value.trim(),
                        key: document.getElementById('apiKey').value.trim(),
                        model: document.getElementById('modelName').value.trim(),
                        systemPrompt: document.getElementById('systemPrompt').value.trim()
                    };

                    const response = await this.callAIAPI('ÊµãËØïËøûÊé•', tempConfig);
                    
                    if (response) {
                        this.showToast('‚úÖ APIËøûÊé•ÊµãËØïÊàêÂäüÔºÅ');
                        const statusEl = document.getElementById('apiStatus');
                        if (statusEl) {
                            statusEl.className = 'api-status success';
                            statusEl.textContent = '‚úÖ APIËøûÊé•ÊµãËØïÊàêÂäüÔºåÂèØ‰ª•Ê≠£Â∏∏‰ΩøÁî®';
                        }
                    }
                } catch (error) {
                    console.error('‚ùå APIÊµãËØïÂ§±Ë¥•:', error);
                    this.showToast('‚ùå APIËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö' + error.message);
                    const statusEl = document.getElementById('apiStatus');
                    if (statusEl) {
                        statusEl.className = 'api-status error';
                        statusEl.textContent = '‚ùå APIËøûÊé•ÊµãËØïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÈÖçÁΩÆ';
                    }
                } finally {
                    testBtn.disabled = false;
                    testBtn.textContent = 'üß™ ÊµãËØïËøûÊé•';
                }
            }

            async generateStory() {
                const storyInput = document.getElementById('storyInput');
                const generateBtn = document.getElementById('generateBtn');
                const input = storyInput ? storyInput.value.trim() : '';
                
                if (!input) {
                    this.showToast('‚ùó ËØ∑ËæìÂÖ•ÊïÖ‰∫ã‰∏ªÈ¢òÊàñÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ‰∏ªÈ¢ò');
                    if (storyInput) storyInput.focus();
                    return;
                }

                // Ê£ÄÊü•APIÈÖçÁΩÆ
                if (!this.apiConfig.key || !this.apiConfig.url) {
                    this.showToast('‚ö†Ô∏è ËØ∑ÂÖàÈÖçÁΩÆAIÊé•Âè£ÊâçËÉΩÁîüÊàêÊïÖ‰∫ã');
                    this.showApiConfig();
                    return;
                }

                console.log('üöÄ ÂºÄÂßãAIÊïÖ‰∫ãÁîüÊàê:', input);
                
                // Á¶ÅÁî®ÁîüÊàêÊåâÈíÆ
                if (generateBtn) {
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'ü§ñ AIÂàõ‰Ωú‰∏≠...';
                }

                this.showPage('loadingPage');
                this.animateLoadingSteps();

                try {
                    // ‰ΩøÁî®Â§ßÊ®°ÂûãÁîüÊàêÊïÖ‰∫ãÂÜÖÂÆπ
                    const story = await this.createStoryWithAI(input);
                    this.currentStory = story;
                    this.currentPageIndex = 0;

                    // ÁîüÊàêÊèíÁîª
                    await this.generateImages(story);

                    this.showStoryPage();
                    console.log('‚ú® AIÊïÖ‰∫ãÁîüÊàêÂÆåÊàê:', story.title);
                    this.showToast('üéâ AIÊïÖ‰∫ãÂàõ‰ΩúÂÆåÊàêÔºÅÂèØ‰ª•ÂºÄÂßãÈòÖËØª‰∫Ü');
                } catch (error) {
                    console.error('‚ùå AIÊïÖ‰∫ãÁîüÊàêÂ§±Ë¥•:', error);
                    this.showToast('üòî AIÊïÖ‰∫ãÁîüÊàêÂ§±Ë¥•Ôºö' + error.message);
                    this.showPage('homePage');
                } finally {
                    // ÊÅ¢Â§çÁîüÊàêÊåâÈíÆ
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.textContent = '‚ú® ÂºÄÂßãÂàõ‰ΩúÊïÖ‰∫ã';
                    }
                }
            }

            async createStoryWithAI(theme) {
                console.log('ü§ñ Ë∞ÉÁî®Â§ßÊ®°ÂûãÁîüÊàêÊïÖ‰∫ã...');
                
                try {
                    const aiResponse = await this.callAIAPI(theme);
                    const story = this.parseAIStoryResponse(aiResponse, theme);
                    
                    if (!story.title || !story.paragraphs || story.paragraphs.length === 0) {
                        throw new Error('AIËøîÂõûÁöÑÊïÖ‰∫ãÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                    }
                    
                    return story;
                } catch (error) {
                    console.error('‚ùå AIÊïÖ‰∫ãÁîüÊàêÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à:', error);
                    // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®È¢ÑËÆæÊ®°Êùø‰Ωú‰∏∫Â§áÁî®
                    return this.createFallbackStory(theme);
                }
            }

            async callAIAPI(userMessage, config = null) {
                const apiConfig = config || this.apiConfig;
                
                const requestBody = {
                    model: apiConfig.model,
                    messages: [
                        {
                            role: "system",
                            content: apiConfig.systemPrompt
                        },
                        {
                            role: "user",
                            content: `ËØ∑‰∏∫‰∏ªÈ¢ò"${userMessage}"Âàõ‰Ωú‰∏Ä‰∏™ÂÑøÁ´•ÊïÖ‰∫ã„ÄÇ`
                        }
                    ],
                    temperature: 0.8,
                    max_tokens: 2000
                };

                console.log('üì° ÂèëÈÄÅAPIËØ∑Ê±Ç:', {
                    url: apiConfig.url,
                    model: apiConfig.model,
                    theme: userMessage
                });

                const response = await fetch(apiConfig.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('üì• Êî∂Âà∞APIÂìçÂ∫î:', data);

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                }

                return data.choices[0].message.content;
            }

            parseAIStoryResponse(aiResponse, theme) {
                console.log('üìù Ëß£ÊûêAIÊïÖ‰∫ãÂìçÂ∫î...');
                
                try {
                    // ÊèêÂèñÊ†áÈ¢ò
                    let title = theme; // ÈªòËÆ§Ê†áÈ¢ò
                    const titleMatch = aiResponse.match(/Ê†áÈ¢ò[Ôºö:]\s*(.+)/);
                    if (titleMatch) {
                        title = titleMatch[1].trim();
                    }

                    // ÊèêÂèñÊÆµËêΩ
                    const paragraphs = [];
                    const paragraphRegex = /Á¨¨[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ\d]+ÊÆµ[Ôºö:]\s*(.+?)(?=Á¨¨[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ\d]+ÊÆµ[Ôºö:]|$)/gs;
                    let match;
                    
                    while ((match = paragraphRegex.exec(aiResponse)) !== null) {
                        const paragraph = match[1].trim();
                        if (paragraph) {
                            paragraphs.push(paragraph);
                        }
                    }

                    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Ê†áÂáÜÊ†ºÂºèÔºåÂ∞ùËØïÊåâÊÆµËêΩÂàÜÂâ≤
                    if (paragraphs.length === 0) {
                        const lines = aiResponse.split('\n').filter(line => line.trim() && !line.includes('Ê†áÈ¢ò'));
                        for (const line of lines) {
                            const cleaned = line.trim();
                            if (cleaned.length > 50) { // ËøáÊª§Â§™Áü≠ÁöÑË°å
                                paragraphs.push(cleaned);
                            }
                        }
                    }

                    // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÊÆµËêΩ
                    if (paragraphs.length < 4) {
                        console.warn('‚ö†Ô∏è AIÁîüÊàêÁöÑÊÆµËêΩÊï∞Èáè‰∏çË∂≥Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                        return this.createFallbackStory(theme);
                    }

                    console.log('‚úÖ ÊïÖ‰∫ãËß£ÊûêÂÆåÊàê:', { title, paragraphs: paragraphs.length });
                    
                    return {
                        title,
                        paragraphs: paragraphs.slice(0, 8), // ÊúÄÂ§ö8‰∏™ÊÆµËêΩ
                        source: 'ai-generated'
                    };
                } catch (error) {
                    console.error('‚ùå Ëß£ÊûêAIÂìçÂ∫îÂ§±Ë¥•:', error);
                    throw new Error('Ëß£ÊûêAIÊïÖ‰∫ãÂ§±Ë¥•');
                }
            }

            createFallbackStory(theme) {
                console.log('üìö ‰ΩøÁî®È¢ÑËÆæÊïÖ‰∫ãÊ®°Êùø');
                
                const fallbackStories = {
                    'ÂãáÊï¢ÁöÑÂ∞èÂä®Áâ©': {
                        title: 'ÂãáÊï¢ÁöÑÂ∞èÂÖîÂ≠êË¥ùË¥ù',
                        paragraphs: [
                            'Âú®‰∏ÄÁâáÁæé‰∏ΩÁöÑÊ£ÆÊûóÈáåÔºå‰ΩèÁùÄ‰∏ÄÂè™ÂêçÂè´Ë¥ùË¥ùÁöÑÂ∞èÂÖîÂ≠ê„ÄÇË¥ùË¥ùÊúâÁùÄÈõ™ÁôΩÁöÑÊØõÂèëÂíåÁ∫¢ÂÆùÁü≥Ëà¨ÁöÑÁúºÁùõÔºå‰ΩÜÂ•πÊÄªÊòØÂæàËÉÜÂ∞èÔºå‰∏çÊï¢Áã¨Ëá™Âá∫Èó®Êé¢Èô©„ÄÇ',
                            '‰∏ÄÂ§©ÔºåÊ£ÆÊûóÈáå‰º†Êù•‰∫ÜÊ±ÇÊïëÂ£∞„ÄÇÂéüÊù•ÊòØÂ∞èÊùæÈº†Â•áÂ•áÊéâËøõ‰∫ÜÊ∑±Ê∑±ÁöÑÂ±±Ê¥ûÈáåÔºåÂ§ßÂÆ∂ÈÉΩ‰∏çÁü•ÈÅìËØ•ÊÄé‰πàÂäû„ÄÇÂä®Áâ©‰ª¨Âõ¥Âú®Ê¥ûÂè£ÔºåÁÑ¶ÊÄ•Âú∞ËÆ®ËÆ∫ÁùÄÊïëÊè¥ÊñπÊ°à„ÄÇ',
                            'Ë¥ùË¥ùÁúãÂà∞Â§ßÂÆ∂ÈÉΩÂæàÁùÄÊÄ•ÔºåÂøÉÈáå‰πüÂæàÈöæËøá„ÄÇËôΩÁÑ∂Â•πÂæàÂÆ≥ÊÄïÔºå‰ΩÜÂ•πÊÉ≥Ëµ∑‰∫ÜÂ¶àÂ¶àËØ¥ËøáÁöÑËØùÔºö"ÁúüÊ≠£ÁöÑÂãáÊï¢‰∏çÊòØ‰∏çÂÆ≥ÊÄïÔºåËÄåÊòØÂç≥‰ΩøÂÆ≥ÊÄï‰πüË¶ÅÂéªÂ∏ÆÂä©Âà´‰∫∫„ÄÇ"',
                            'Ë¥ùË¥ùÊ∑±Ê∑±Âê∏‰∫Ü‰∏ÄÂè£Ê∞îÔºåÂãáÊï¢Âú∞Ë∑≥Ëøõ‰∫ÜÂ±±Ê¥û„ÄÇÊ¥ûÈáåÂæàÈªëÔºåÂ•πÁöÑÂøÉÊÄ¶ÊÄ¶Áõ¥Ë∑≥Ôºå‰ΩÜÂ•πÊÉ≥ÁùÄÂ•áÂ•áÈúÄË¶ÅÂ∏ÆÂä©ÔºåÂ∞±‰∏ÄÊ≠•‰∏ÄÊ≠•Â∞èÂøÉÂú∞ÂæÄ‰∏ãËµ∞„ÄÇ',
                            'Áªà‰∫éÔºåË¥ùË¥ùÊâæÂà∞‰∫ÜÂèó‰º§ÁöÑÂ•áÂ•á„ÄÇÂ•πÊ∏©ÊüîÂú∞ÂÆâÊÖ∞Â•áÂ•áÔºåÁÑ∂ÂêéËÉåÁùÄ‰ªñÊÖ¢ÊÖ¢Áà¨Âá∫‰∫ÜÂ±±Ê¥û„ÄÇÂΩìÂ§ßÂÆ∂ÁúãÂà∞Ë¥ùË¥ùÂÆâÂÖ®Âú∞ÊïëÂá∫Â•áÂ•áÊó∂ÔºåÈÉΩ‰∏∫Â•πÈºìÊéåÂñùÂΩ©„ÄÇ',
                            '‰ªéÈÇ£Â§©Ëµ∑ÔºåË¥ùË¥ùÂÜç‰πü‰∏çÊòØÈÇ£Âè™ËÉÜÂ∞èÁöÑÂ∞èÂÖîÂ≠ê‰∫Ü„ÄÇÂ•πÂ≠¶‰ºö‰∫ÜÂãáÊï¢Ôºå‰πüÊòéÁôΩ‰∫ÜÂ∏ÆÂä©Âà´‰∫∫‰ºöËÆ©Ëá™Â∑±ÂèòÂæóÊõ¥Âä†Âº∫Â§ßÂíåÂø´‰πê„ÄÇ'
                        ]
                    }
                };

                // ËøîÂõûÂåπÈÖçÁöÑÊïÖ‰∫ãÊàñÁîüÊàêÁÆÄÂçïÊïÖ‰∫ã
                return fallbackStories[theme] || {
                    title: `${theme}ÁöÑÊïÖ‰∫ã`,
                    paragraphs: [
                        `ËøôÊòØ‰∏Ä‰∏™ÂÖ≥‰∫é${theme}ÁöÑÁæéÂ¶ôÊïÖ‰∫ã„ÄÇÂú®‰∏Ä‰∏™ÂÖÖÊª°Â•áËøπÁöÑ‰∏ñÁïåÈáåÔºåÊàë‰ª¨ÁöÑ‰∏ª‰∫∫ÂÖ¨Âç≥Â∞ÜÂºÄÂßã‰∏ÄÊÆµÈöæÂøòÁöÑÂÜíÈô©ÊóÖÁ®ã„ÄÇ`,
                        `‰∏ª‰∫∫ÂÖ¨ÈÅáÂà∞‰∫ÜÂêÑÁßçÊúâË∂£ÁöÑÊåëÊàòÂíåÊúãÂèãÔºåÊØè‰∏ÄÊ¨°ÁªèÂéÜÈÉΩËÆ©‰ªñÂ≠¶Âà∞‰∫ÜÁèçË¥µÁöÑ‰∫∫ÁîüÁªèÈ™åÔºåÂèòÂæóÊõ¥Âä†ÂãáÊï¢ÂíåÊô∫ÊÖß„ÄÇ`,
                        `ÈÄöËøáÂä™ÂäõÂíåÂùöÊåÅÔºå‰∏ª‰∫∫ÂÖ¨‰∏ç‰ªÖÂ∏ÆÂä©‰∫ÜËÆ∏Â§öÈúÄË¶ÅÂ∏ÆÂä©ÁöÑ‰∫∫Ôºå‰πüÂèëÁé∞‰∫ÜËá™Â∑±ÂÜÖÂøÉÊ∑±Â§ÑÁöÑÂäõÈáèÂíåÁæéÂ•ΩÂìÅË¥®„ÄÇ`,
                        `ÊúÄÁªàÔºåËøô‰∏™ÂÖ≥‰∫é${theme}ÁöÑÊïÖ‰∫ãÂëäËØâÊàë‰ª¨ÔºåÂè™Ë¶Å‰øùÊåÅÂñÑËâØÁöÑÂøÉÂíåÂãáÊï¢ÁöÑÁ≤æÁ•ûÔºåÂ∞±ËÉΩÂàõÈÄ†Â±û‰∫éËá™Â∑±ÁöÑÁ≤æÂΩ©‰∫∫Áîü„ÄÇ`
                    ],
                    source: 'fallback'
                };
            }

            async generateImages(story) {
                if (!story) return;
                
                story.images = [];
                
                // È´òË¥®ÈáèÂõæÁâáÂ∫ìÔºåÊ†πÊçÆÂÜÖÂÆπÂåπÈÖç
                const imageLibrary = {
                    'ÂÖîÂ≠ê': [
                        'https://images.unsplash.com/photo-1585110396000-c9ffd4e4b308?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1425082661705-1834bfd09dca?w=400&h=300&fit=crop&q=80'
                    ],
                    'Ê£ÆÊûó': [
                        'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop&q=80'
                    ],
                    'ÂèãË∞ä': [
                        'https://images.unsplash.com/photo-1529903475582-154eb4c7ee9a?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1523800503107-5bc3ba2a6f81?w=400&h=300&fit=crop&q=80'
                    ],
                    'Êµ∑Â∫ï': [
                        'https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=400&h=300&fit=crop&q=80'
                    ],
                    'Â§™Á©∫': [
                        'https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=400&h=300&fit=crop&q=80'
                    ],
                    'ÂÖ¨‰∏ª': [
                        'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop&q=80'
                    ],
                    'Ëä±Âõ≠': [
                        'https://images.unsplash.com/photo-1492571350019-22de08371fd3?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400&h=300&fit=crop&q=80'
                    ],
                    'ÂÜíÈô©': [
                        'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1506197603052-3cc9c3a201bd?w=400&h=300&fit=crop&q=80'
                    ]
                };

                // ÈªòËÆ§ÂõæÁâá
                const defaultImages = [
                    'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1529655683826-aba9b3e77383?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop&q=80'
                ];

                for (let i = 0; i < story.paragraphs.length; i++) {
                    let selectedImages = defaultImages;
                    
                    // Ê†πÊçÆÊÆµËêΩÂÜÖÂÆπÂíåÊïÖ‰∫ãÊ†áÈ¢òÈÄâÊã©ÂêàÈÄÇÁöÑÂõæÁâá
                    const content = (story.paragraphs[i] + ' ' + story.title).toLowerCase();
                    
                    for (const [keyword, images] of Object.entries(imageLibrary)) {
                        if (content.includes(keyword) || content.includes(keyword.toLowerCase())) {
                            selectedImages = images;
                            break;
                        }
                    }
                    
                    // ÈÄâÊã©ÂõæÁâáÂπ∂Ê∑ªÂä†Âà∞ÊïÖ‰∫ã‰∏≠
                    const imageIndex = i % selectedImages.length;
                    story.images.push(selectedImages[imageIndex]);
                    
                    await this.delay(200 + Math.random() * 300);
                }

                console.log('üé® ÊïÖ‰∫ãÊèíÁîªÁîüÊàêÂÆåÊàêÔºåÂÖ±', story.images.length, 'Âº†');
            }

            animateLoadingSteps() {
                const steps = ['step1', 'step2', 'step3'];
                let currentStep = 0;

                this.loadingInterval = setInterval(() => {
                    if (currentStep < steps.length) {
                        const stepElement = document.getElementById(steps[currentStep]);
                        if (stepElement) {
                            stepElement.classList.add('active');
                        }
                        currentStep++;
                    } else {
                        clearInterval(this.loadingInterval);
                        this.loadingInterval = null;
                    }
                }, 1000);
            }

            showStoryPage() {
                this.showPage('storyPage');
                this.updateStoryDisplay();
            }

            updateStoryDisplay() {
                if (!this.currentStory) return;

                const storyTitle = document.getElementById('storyTitle');
                const currentPage = document.getElementById('currentPage');
                const totalPages = document.getElementById('totalPages');
                const storyParagraph = document.getElementById('storyParagraph');

                if (storyTitle) storyTitle.textContent = this.currentStory.title;
                if (currentPage) currentPage.textContent = this.currentPageIndex + 1;
                if (totalPages) totalPages.textContent = this.currentStory.paragraphs.length;
                if (storyParagraph) storyParagraph.textContent = this.currentStory.paragraphs[this.currentPageIndex];
                
                // Êõ¥Êñ∞ÂõæÁâá
                this.updateStoryImage();
                
                // Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆÁä∂ÊÄÅ
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                if (prevBtn) prevBtn.disabled = this.currentPageIndex === 0;
                if (nextBtn) {
                    nextBtn.textContent = this.currentPageIndex === this.currentStory.paragraphs.length - 1 ? 'ÁªìÊùü ‚Üí' : '‰∏ã‰∏ÄÈ°µ ‚Üí';
                }
                
                // ÂÅúÊ≠¢ÂΩìÂâçÊí≠Êîæ
                this.stopPlayback();
            }

            updateStoryImage() {
                const img = document.getElementById('storyImg');
                const loading = document.getElementById('imageLoading');
                
                if (!img || !loading || !this.currentStory?.images) return;
                
                const imageUrl = this.currentStory.images[this.currentPageIndex];
                if (imageUrl) {
                    loading.style.display = 'flex';
                    img.style.display = 'none';
                    
                    img.onload = () => {
                        loading.style.display = 'none';
                        img.style.display = 'block';
                    };
                    
                    img.onerror = () => {
                        loading.style.display = 'none';
                        img.style.display = 'block';
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjQwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiNGNUY1RjUiLz48cGF0aCBkPSJNMTc1IDEyNUwyMjUgMTc1TDI3NSAxMjVIMzI1TDI3NSA3NUwyMjUgMTI1TDE3NSA3NUgxMjVMMTc1IDEyNVoiIGZpbGw9IiNEMUQxRDEiLz48L3N2Zz4=';
                    };
                    
                    img.src = imageUrl;
                    img.alt = `AIÁîüÊàêÊïÖ‰∫ãÊèíÁîª - Á¨¨${this.currentPageIndex + 1}È°µ`;
                }
            }

            previousPage() {
                if (this.currentPageIndex > 0) {
                    this.currentPageIndex--;
                    this.updateStoryDisplay();
                    this.showToast(`üìñ Á¨¨ ${this.currentPageIndex + 1} È°µ`);
                }
            }

            nextPage() {
                if (this.currentPageIndex < this.currentStory.paragraphs.length - 1) {
                    this.currentPageIndex++;
                    this.updateStoryDisplay();
                    this.showToast(`üìñ Á¨¨ ${this.currentPageIndex + 1} È°µ`);
                } else {
                    this.showPage('endPage');
                    this.showToast('üéâ AIÊïÖ‰∫ãËØªÂÆå‰∫ÜÔºÅÂ∏åÊúõ‰Ω†ÂñúÊ¨¢');
                }
            }

            togglePlayback() {
                if (this.isPlaying) {
                    this.stopPlayback();
                } else {
                    this.startPlayback();
                }
            }

            startPlayback() {
                if (!this.currentStory || !this.speechSynthesis) {
                    this.showToast('‚ùå ËØ≠Èü≥ÂäüËÉΩÊöÇ‰∏çÂèØÁî®');
                    return;
                }

                const text = this.currentStory.paragraphs[this.currentPageIndex];
                const speedSelect = document.getElementById('speedSelect');
                const speed = speedSelect ? parseFloat(speedSelect.value) : 1.0;

                this.currentUtterance = new SpeechSynthesisUtterance(text);
                this.currentUtterance.rate = speed;
                this.currentUtterance.pitch = 1.1;
                this.currentUtterance.volume = 1;

                const voices = this.speechSynthesis.getVoices();
                const chineseVoice = voices.find(voice => 
                    voice.lang.includes('zh') || 
                    voice.lang.includes('CN') ||
                    voice.name.includes('Chinese')
                );
                if (chineseVoice) {
                    this.currentUtterance.voice = chineseVoice;
                }

                this.currentUtterance.onstart = () => {
                    this.isPlaying = true;
                    this.updatePlayButton();
                    this.startTextHighlight(text);
                    console.log('üéµ ÂºÄÂßãËØ≠Èü≥ÊúóËØª');
                };

                this.currentUtterance.onend = () => {
                    this.isPlaying = false;
                    this.updatePlayButton();
                    this.clearTextHighlight();
                    console.log('‚èπÔ∏è ËØ≠Èü≥ÊúóËØªÁªìÊùü');
                };

                this.currentUtterance.onerror = (error) => {
                    this.isPlaying = false;
                    this.updatePlayButton();
                    this.showToast('üòî ËØ≠Èü≥Êí≠ÊîæÂá∫ÈîôÔºåËØ∑ÈáçËØï');
                    console.error('‚ùå TTSÈîôËØØ:', error);
                };

                try {
                    this.speechSynthesis.speak(this.currentUtterance);
                    this.showToast('üéµ ÂºÄÂßãÊúóËØªAIÊïÖ‰∫ã');
                } catch (error) {
                    console.error('‚ùå ËØ≠Èü≥Êí≠ÊîæÂ§±Ë¥•:', error);
                    this.showToast('‚ùå ËØ≠Èü≥ÂäüËÉΩÊöÇ‰∏çÂèØÁî®');
                }
            }

            stopPlayback() {
                if (this.speechSynthesis) {
                    this.speechSynthesis.cancel();
                }
                this.isPlaying = false;
                this.updatePlayButton();
                this.clearTextHighlight();
            }

            updatePlayButton() {
                const playBtn = document.getElementById('playBtn');
                if (playBtn) {
                    playBtn.textContent = this.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                    playBtn.title = this.isPlaying ? 'ÊöÇÂÅúÊúóËØª' : 'Êí≠ÊîæÊúóËØª';
                }
            }

            startTextHighlight(text) {
                this.clearTextHighlight();
                
                const paragraph = document.getElementById('storyParagraph');
                if (!paragraph || !text) return;

                const chars = text.split('');
                let currentIndex = 0;
                
                const highlightInterval = setInterval(() => {
                    if (currentIndex < chars.length && this.isPlaying) {
                        this.highlightCharacter(paragraph, currentIndex, text);
                        currentIndex++;
                    } else {
                        clearInterval(highlightInterval);
                    }
                }, 120);
                
                this.highlightTimeout = highlightInterval;
            }

            highlightCharacter(paragraph, index, originalText) {
                if (!paragraph || !originalText) return;

                const beforeText = originalText.substring(0, index);
                const currentChar = originalText.charAt(index);
                const afterText = originalText.substring(index + 1);
                
                paragraph.innerHTML = beforeText + 
                                     `<span class="highlight">${currentChar}</span>` + 
                                     afterText;
            }

            clearTextHighlight() {
                if (this.highlightTimeout) {
                    clearInterval(this.highlightTimeout);
                    this.highlightTimeout = null;
                }
                
                const paragraph = document.getElementById('storyParagraph');
                if (paragraph && this.currentStory) {
                    paragraph.textContent = this.currentStory.paragraphs[this.currentPageIndex] || '';
                }
            }

            saveStory() {
                if (!this.currentStory) {
                    this.showToast('‚ùå Ê≤°ÊúâÊïÖ‰∫ãÂèØ‰ª•‰øùÂ≠ò');
                    return;
                }
                
                try {
                    const savedStories = JSON.parse(localStorage.getItem('savedStories') || '[]');
                    const storyToSave = {
                        ...this.currentStory,
                        savedAt: new Date().toISOString(),
                        id: Date.now()
                    };
                    
                    savedStories.push(storyToSave);
                    localStorage.setItem('savedStories', JSON.stringify(savedStories));
                    
                    const sourceText = this.currentStory.source === 'ai-generated' ? 'AIÁîüÊàêÁöÑ' : '';
                    this.showToast(`üíæ ${sourceText}ÊïÖ‰∫ãÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®ÔºÅ`);
                    console.log('üíæ ÊïÖ‰∫ã‰øùÂ≠òÊàêÂäü:', storyToSave.title);
                } catch (error) {
                    console.error('‚ùå ‰øùÂ≠òÊïÖ‰∫ãÂ§±Ë¥•:', error);
                    this.showToast('üòî ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ËÆæÁΩÆ');
                }
            }

            shareStory() {
                if (!this.currentStory) {
                    this.showToast('‚ùå Ê≤°ÊúâÊïÖ‰∫ãÂèØ‰ª•ÂàÜ‰∫´');
                    return;
                }
                
                const aiLabel = this.currentStory.source === 'ai-generated' ? 'AIÂàõ‰ΩúÁöÑ' : '';
                const shareText = `ÊàëÂú®AIÁªòÊú¨ÂàõÂª∫‰∫Ü‰∏Ä‰∏™Á≤æÂΩ©ÁöÑ${aiLabel}ÊïÖ‰∫ãÔºö„Ää${this.currentStory.title}„Äã\n\nËøôÊòØ‰∏Ä‰∏™ÈõÜÊàê‰∫ÜÂ§ßÊ®°ÂûãAIÁöÑÂÑøÁ´•ÁªòÊú¨Âàõ‰ΩúÂ∑•ÂÖ∑ÔºåÊîØÊåÅÊô∫ËÉΩÊïÖ‰∫ãÁîüÊàê„ÄÅÊèíÁîªÈÖçÂõæÂíåËØ≠Èü≥ÊúóËØª„ÄÇÂø´Êù•‰∏ÄËµ∑Âàõ‰ΩúÂ±û‰∫é‰Ω†ÁöÑÊïÖ‰∫ãÂêßÔºÅ\n\n‚ú® ÁâπËâ≤ÂäüËÉΩÔºö\nü§ñ Â§ßÊ®°ÂûãAIÊô∫ËÉΩÊïÖ‰∫ãÂàõ‰Ωú\nüé® Á≤æÁæéÊèíÁîªËá™Âä®ÈÖçÂõæ\nüéµ ËØ≠Èü≥ÊúóËØªË∑üËØª‰ΩìÈ™å\nüì± ÁßªÂä®Á´ØÂÆåÁæéÈÄÇÈÖç\nüíæ Êú¨Âú∞ÊïÖ‰∫ã‰øùÂ≠òÁÆ°ÁêÜ`;
                
                if (navigator.share) {
                    navigator.share({
                        title: `AIÁªòÊú¨ - ${this.currentStory.title}`,
                        text: shareText,
                        url: window.location.href
                    }).then(() => {
                        this.showToast('üì§ ÂàÜ‰∫´ÊàêÂäüÔºÅ');
                    }).catch((error) => {
                        console.log('ÂàÜ‰∫´ÂèñÊ∂àÊàñÂ§±Ë¥•:', error);
                        this.fallbackShare(shareText);
                    });
                } else {
                    this.fallbackShare(shareText);
                }
            }

            fallbackShare(text) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showToast('üìã ÂàÜ‰∫´ÊñáÊ°àÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
                    }).catch(() => {
                        this.showManualShare(text);
                    });
                } else {
                    this.showManualShare(text);
                }
            }

            showManualShare(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    this.showToast('üìã ÂàÜ‰∫´ÊñáÊ°àÂ∑≤Â§çÂà∂ÔºÅ');
                } catch (err) {
                    this.showToast('üí° ËØ∑ÊâãÂä®Â§çÂà∂ÂàÜ‰∫´ÊñáÊ°à');
                    console.log('ÂàÜ‰∫´ÂÜÖÂÆπ:', text);
                }
                
                document.body.removeChild(textArea);
            }

            goHome() {
                this.stopPlayback();
                this.currentStory = null;
                this.currentPageIndex = 0;
                
                const storyInput = document.getElementById('storyInput');
                if (storyInput) {
                    storyInput.value = '';
                    storyInput.focus();
                }
                
                this.showPage('homePage');
                this.showToast('üè† Ê¨¢ËøéÂõûÂà∞È¶ñÈ°µÔºåÂºÄÂßãÊñ∞ÁöÑAIÊïÖ‰∫ãÂàõ‰ΩúÂêßÔºÅ');
            }

            showPage(pageId) {
                if (this.loadingInterval) {
                    clearInterval(this.loadingInterval);
                    this.loadingInterval = null;
                }

                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('active');
                });

                document.querySelectorAll('.page').forEach(page => {
                    page.style.display = 'none';
                });
                
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.style.display = 'flex';
                    console.log('üìÑ ÂàáÊç¢Âà∞È°µÈù¢:', pageId);
                }
            }

            showToast(message, duration = 3000) {
                console.log('üì¢', message);
                const toast = document.getElementById('toast');
                if (!toast) return;

                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            destroy() {
                this.stopPlayback();
                if (this.loadingInterval) {
                    clearInterval(this.loadingInterval);
                }
                if (this.highlightTimeout) {
                    clearInterval(this.highlightTimeout);
                }
            }
        }

        // Â∫îÁî®ÂàùÂßãÂåñ
        let storyApp = null;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéØ DOMÂÜÖÂÆπÂä†ËΩΩÂÆåÊàê');
            storyApp = new StoryApp();
        });

        window.addEventListener('beforeunload', () => {
            if (storyApp) {
                storyApp.destroy();
            }
        });

        // Èò≤Ê≠¢È°µÈù¢Áº©ÊîæÂíåÂèåÂáª
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = new Date().getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        document.addEventListener('contextmenu', function(event) {
            event.preventDefault();
        });

        // ÈîôËØØÂ§ÑÁêÜ
        window.addEventListener('error', (error) => {
            console.error('üö® ÂÖ®Â±ÄÈîôËØØ:', error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('üö® Êú™Â§ÑÁêÜÁöÑPromiseÈîôËØØ:', event.reason);
        });

        console.log('üéâ AIÁªòÊú¨Â∫îÁî®ËÑöÊú¨Âä†ËΩΩÂÆåÊàê - Â§ßÊ®°ÂûãÁâàÊú¨');
    </script>
</body>
</html>