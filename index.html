<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ¨ AIç»˜æœ¬ - å„¿ç«¥æ•…äº‹ç”Ÿæˆå™¨</title>
    <meta name="description" content="ä¸º3-8å²å„¿ç«¥è®¾è®¡çš„AIç»˜æœ¬åˆ›ä½œå·¥å…·ï¼Œæ”¯æŒå¤§æ¨¡å‹æ•…äº‹ç”Ÿæˆã€æ’ç”»é…å›¾å’Œè¯­éŸ³æœ—è¯»">
    <meta name="keywords" content="AIç»˜æœ¬,å„¿ç«¥æ•…äº‹,è¯­éŸ³æœ—è¯»,ç§»åŠ¨ç«¯,æ•™è‚²,å¤§æ¨¡å‹">
    
    <!-- æ·»åŠ PWAæ”¯æŒ -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQUnnu5jmnKwiLCJzaG9ydF9uYW1lIjoiQUnnu5jmnKwiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiM2NjdlZWEiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBNU5pQTVOaUlnZG1WeWMybHZiajBpTVM0eElpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTVoY21jdk1qQXdNQzl6ZG1jaVBnbzhZMmx5WTJ4bElHTjRQU0kwT0NJZ1kza1BTSDBPV0NJZ2NqMGlNemt1TmlJZ1ptbHNiRDBpSXpZMk4yVmxZU0lnTHo0OGRHVjRkQ0I0UFNJek5pSWdlVDBpTlRRaUlHWnZiblF0Wm1GdGFXeDVQU0pCY21saGJDSWdabTl1ZEMxemFYcGxQU0l6TUhCNElpQm1hV3hzUFNJalptWm1JaUErOEFvZ1FVa080NGEvYStlN21PZStpVGdnUEM5MFpYaDBQZzhMM04yWnoiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é¦–é¡µæ ·å¼ */
        #homePage {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .header {
            margin-bottom: 40px;
            position: relative;
        }

        .settings-btn {
            position: absolute;
            top: -10px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .settings-btn:hover, .settings-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }

        .logo {
            font-size: 2.8rem;
            color: #fff;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .subtitle {
            color: #fff;
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 35px 30px;
            margin-bottom: 30px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .input-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.2);
        }

        .input-section h2 {
            color: #5a67d8;
            margin-bottom: 25px;
            font-size: 1.4rem;
            font-weight: 600;
        }

        #storyInput {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1.05rem;
            margin-bottom: 25px;
            background: #fff;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #storyInput:focus {
            outline: none;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }

        .primary-btn {
            width: 100%;
            padding: 18px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.15rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
            font-family: inherit;
        }

        .primary-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .primary-btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .preset-themes {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px);
        }

        .preset-themes h3 {
            color: #5a67d8;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .theme-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .theme-tag {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #fff;
            padding: 12px 18px;
            border-radius: 28px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .theme-tag:hover, .theme-tag:active {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 154, 158, 0.4);
        }

        /* åŠ è½½é¡µæ ·å¼ */
        #loadingPage {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .loading-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 45px 35px;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            max-width: 400px;
            width: 100%;
        }

        .magic-wand {
            font-size: 3.5rem;
            animation: sparkle 2s ease-in-out infinite;
            margin-bottom: 25px;
            position: relative;
        }

        .magic-wand:after {
            content: 'âœ¨';
            position: absolute;
            top: -10px;
            right: -15px;
            font-size: 1.5rem;
            animation: twinkle 1.5s ease-in-out infinite alternate;
        }

        @keyframes sparkle {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(12deg) scale(1.1); }
            75% { transform: rotate(-12deg) scale(1.1); }
        }

        @keyframes twinkle {
            0% { opacity: 0.5; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .loading-text {
            font-size: 1.3rem;
            color: #5a67d8;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .step {
            padding: 14px 22px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            color: #5a67d8;
            font-weight: 600;
            opacity: 0.6;
            transition: all 0.4s ease;
            border-left: 4px solid transparent;
        }

        .step.active {
            opacity: 1;
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(8px);
            border-left-color: #667eea;
        }

        /* APIé…ç½®æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: #5a67d8;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #a0aec0;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: #5a67d8;
            background: rgba(90, 103, 216, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .form-help {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }

        .api-status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .api-status.success {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }

        .api-status.error {
            background: rgba(245, 101, 101, 0.1);
            color: #e53e3e;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }

        .api-status.warning {
            background: rgba(237, 137, 54, 0.1);
            color: #dd6b20;
            border: 1px solid rgba(237, 137, 54, 0.3);
        }

        /* æ•…äº‹é˜…è¯»é¡µå’Œå…¶ä»–é¡µé¢æ ·å¼ä¿æŒä¸å˜... */
        
        /* æ•…äº‹é˜…è¯»é¡µæ ·å¼ */
        #storyPage {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 0;
        }

        .story-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .icon-btn {
            background: rgba(90, 103, 216, 0.1);
            border: none;
            font-size: 1.8rem;
            color: #5a67d8;
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .icon-btn:hover, .icon-btn:active {
            background: rgba(90, 103, 216, 0.2);
            transform: scale(1.1);
        }

        #storyTitle {
            font-size: 1.3rem;
            color: #5a67d8;
            font-weight: 700;
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }

        .page-indicator {
            font-size: 1rem;
            color: #667eea;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
        }

        .story-content {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .story-image {
            position: relative;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            aspect-ratio: 4/3;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
            background: linear-gradient(45deg, #f0f2f5 25%, #e2e8f0 50%, #f0f2f5 75%);
            background-size: 400% 400%;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .story-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            transition: all 0.5s ease-in-out;
        }

        .image-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-loading p {
            color: #667eea;
            font-weight: 600;
            font-size: 1rem;
        }

        .story-text {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px);
        }

        #storyParagraph {
            font-size: 1.15rem;
            line-height: 1.9;
            color: #4a5568;
            text-align: justify;
            font-weight: 400;
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 3px 6px;
            border-radius: 6px;
            animation: glow 1s ease-in-out infinite alternate;
            position: relative;
            box-shadow: 0 2px 8px rgba(168, 237, 234, 0.4);
        }

        @keyframes glow {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.02); }
        }

        .control-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 18px;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 14px 18px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            min-width: 85px;
            font-family: inherit;
        }

        .nav-btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .nav-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 18px;
            flex: 1;
            justify-content: center;
        }

        .play-btn {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(255, 154, 158, 0.3);
        }

        .play-btn:hover, .play-btn:active {
            transform: scale(1.15);
            box-shadow: 0 8px 30px rgba(255, 154, 158, 0.5);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            color: #5a67d8;
            font-weight: 600;
        }

        #speedSelect {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.85rem;
            background: white;
            color: #4a5568;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #speedSelect:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ç»“æŸé¡µæ ·å¼ */
        #endPage {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .end-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 45px 35px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
            max-width: 420px;
            width: 100%;
        }

        .celebration {
            font-size: 4.5rem;
            animation: bounce 2s ease-in-out infinite;
            margin-bottom: 25px;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-25px); }
            60% { transform: translateY(-12px); }
        }

        .end-container h2 {
            color: #5a67d8;
            font-size: 1.6rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .end-container p {
            color: #667eea;
            font-size: 1.05rem;
            margin-bottom: 35px;
            opacity: 0.9;
            font-weight: 500;
        }

        .end-actions {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .secondary-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #5a67d8;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 14px;
            padding: 14px 24px;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 600;
            font-family: inherit;
        }

        .secondary-btn:hover, .secondary-btn:active {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        /* Toastæç¤º */
        .toast {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 14px 24px;
            border-radius: 30px;
            font-size: 0.95rem;
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 600;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(15px);
        }

        /* éšè—å…¶ä»–é¡µé¢ */
        .page:not(#homePage) {
            display: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .page { padding: 18px; }
            .logo { font-size: 2.3rem; }
            .input-section { padding: 28px 22px; }
            .preset-themes { padding: 25px; }
            .story-content { padding: 18px; }
            .control-bar { padding: 20px; gap: 15px; }
            .nav-btn { padding: 12px 15px; font-size: 0.85rem; min-width: 75px; }
            .play-btn { width: 50px; height: 50px; font-size: 1.1rem; }
            .audio-controls { gap: 15px; }
            .modal-content { padding: 25px; }
        }

        @media (max-width: 360px) {
            .theme-tags { gap: 10px; }
            .theme-tag { padding: 10px 14px; font-size: 0.85rem; }
            .control-bar { 
                flex-direction: column; 
                gap: 18px; 
                padding: 18px;
            }
            .nav-btn { 
                width: 100%; 
                justify-content: center;
                min-width: unset;
            }
            .audio-controls {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- é¦–é¡µ -->
    <div class="page" id="homePage">
        <div class="header">
            <button id="settingsBtn" class="settings-btn" title="AIè®¾ç½®">âš™ï¸</button>
            <h1 class="logo">ğŸ¨ AIç»˜æœ¬</h1>
            <p class="subtitle">ä¸ºå­©å­åˆ›é€ æ— é™æƒ³è±¡çš„æ•…äº‹ä¸–ç•Œ</p>
        </div>
        
        <div class="input-section">
            <h2>å‘Šè¯‰æˆ‘ä½ æƒ³å¬ä»€ä¹ˆæ•…äº‹ï¼Ÿ</h2>
            <input type="text" id="storyInput" placeholder="ä¾‹å¦‚ï¼šå‹‡æ•¢çš„å°å…”å­" maxlength="50" autocomplete="off">
            <button id="generateBtn" class="primary-btn" title="å¼€å§‹åˆ›ä½œæ•…äº‹">
                âœ¨ å¼€å§‹åˆ›ä½œæ•…äº‹
            </button>
        </div>
        
        <div class="preset-themes">
            <h3>æˆ–è€…é€‰æ‹©ä¸€ä¸ªä¸»é¢˜ï¼š</h3>
            <div class="theme-tags">
                <span class="theme-tag" data-theme="å‹‡æ•¢çš„å°åŠ¨ç‰©" title="ç‚¹å‡»é€‰æ‹©">ğŸ° å‹‡æ•¢å°åŠ¨ç‰©</span>
                <span class="theme-tag" data-theme="ç¥å¥‡çš„æ£®æ—" title="ç‚¹å‡»é€‰æ‹©">ğŸŒ² ç¥å¥‡æ£®æ—</span>
                <span class="theme-tag" data-theme="å‹è°Šçš„åŠ›é‡" title="ç‚¹å‡»é€‰æ‹©">ğŸ‘« å‹è°Šæ•…äº‹</span>
                <span class="theme-tag" data-theme="å¥‡å¦™çš„æµ·åº•ä¸–ç•Œ" title="ç‚¹å‡»é€‰æ‹©">ğŸ  æµ·åº•ä¸–ç•Œ</span>
                <span class="theme-tag" data-theme="å¤ªç©ºå¤§å†’é™©" title="ç‚¹å‡»é€‰æ‹©">ğŸš€ å¤ªç©ºå†’é™©</span>
                <span class="theme-tag" data-theme="å–„è‰¯çš„å°å…¬ä¸»" title="ç‚¹å‡»é€‰æ‹©">ğŸ‘¸ ç«¥è¯å…¬ä¸»</span>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½é¡µ -->
    <div class="page" id="loadingPage">
        <div class="loading-container">
            <div class="magic-wand" role="img" aria-label="é­”æ³•æ£’">âœ¨</div>
            <div class="loading-text">AIæ­£åœ¨ä¸ºä½ åˆ›ä½œæ•…äº‹...</div>
            <div class="loading-steps">
                <div class="step" id="step1">ğŸ¤– å¤§æ¨¡å‹æ„æ€æ•…äº‹æƒ…èŠ‚</div>
                <div class="step" id="step2">ğŸ¨ AIç»˜åˆ¶ç²¾ç¾æ’ç”»</div>
                <div class="step" id="step3">ğŸµ å‡†å¤‡è¯­éŸ³æœ—è¯»</div>
            </div>
        </div>
    </div>
    
    <!-- æ•…äº‹é˜…è¯»é¡µ -->
    <div class="page" id="storyPage">
        <div class="story-header">
            <button id="backBtn" class="icon-btn" title="è¿”å›é¦–é¡µ" aria-label="è¿”å›é¦–é¡µ">â†</button>
            <h2 id="storyTitle">æ•…äº‹æ ‡é¢˜</h2>
            <div class="page-indicator" role="status" aria-live="polite">
                <span id="currentPage">1</span> / <span id="totalPages">1</span>
            </div>
        </div>
        
        <div class="story-content">
            <div class="story-image">
                <img id="storyImg" src="" alt="æ•…äº‹æ’ç”»" style="display: none;">
                <div class="image-loading" id="imageLoading" role="status" aria-live="polite">
                    <div class="spinner" aria-label="åŠ è½½ä¸­"></div>
                    <p>æ­£åœ¨ç»˜åˆ¶æ’ç”»...</p>
                </div>
            </div>
            
            <div class="story-text">
                <p id="storyParagraph" role="main"></p>
            </div>
        </div>
        
        <div class="control-bar" role="toolbar" aria-label="æ•…äº‹æ§åˆ¶">
            <button id="prevBtn" class="nav-btn" disabled title="ä¸Šä¸€é¡µ" aria-label="ä¸Šä¸€é¡µ">
                â† ä¸Šä¸€é¡µ
            </button>
            
            <div class="audio-controls">
                <button id="playBtn" class="play-btn" title="æ’­æ”¾/æš‚åœ" aria-label="æ’­æ”¾æœ—è¯»">â–¶ï¸</button>
                <div class="speed-control">
                    <label for="speedSelect">è¯­é€Ÿ:</label>
                    <select id="speedSelect" title="é€‰æ‹©æœ—è¯»è¯­é€Ÿ">
                        <option value="0.8">æ…¢</option>
                        <option value="1.0" selected>æ­£å¸¸</option>
                        <option value="1.2">å¿«</option>
                    </select>
                </div>
            </div>
            
            <button id="nextBtn" class="nav-btn" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ">
                ä¸‹ä¸€é¡µ â†’
            </button>
        </div>
    </div>
    
    <!-- ç»“æŸé¡µ -->
    <div class="page" id="endPage">
        <div class="end-container">
            <div class="celebration" role="img" aria-label="åº†ç¥">ğŸ‰</div>
            <h2>æ•…äº‹ç»“æŸå•¦ï¼</h2>
            <p>å¸Œæœ›ä½ å–œæ¬¢è¿™ä¸ªç¾å¦™çš„æ•…äº‹ï½</p>
            
            <div class="end-actions">
                <button id="newStoryBtn" class="primary-btn" title="åˆ›ä½œæ–°æ•…äº‹">
                    âœ¨ å†æ¥ä¸€ä¸ªæ•…äº‹
                </button>
                <button id="saveStoryBtn" class="secondary-btn" title="ä¿å­˜åˆ°æœ¬åœ°">
                    ğŸ“– ä¿å­˜æ•…äº‹
                </button>
                <button id="shareStoryBtn" class="secondary-btn" title="åˆ†äº«ç»™æœ‹å‹">
                    ğŸ“¤ åˆ†äº«ç»˜æœ¬
                </button>
            </div>
        </div>
    </div>

    <!-- APIé…ç½®æ¨¡æ€æ¡† -->
    <div id="apiConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¤– AIå¤§æ¨¡å‹é…ç½®</h3>
                <button id="closeApiConfigBtn" class="close-btn">Ã—</button>
            </div>
            
            <div id="apiStatus" class="api-status warning">
                âš ï¸ è¯·é…ç½®AIæ¥å£ä»¥å¯ç”¨æ™ºèƒ½æ•…äº‹ç”ŸæˆåŠŸèƒ½
            </div>
            
            <form id="apiConfigForm">
                <div class="form-group">
                    <label for="apiUrl">API æ¥å£åœ°å€</label>
                    <input type="url" id="apiUrl" value="https://ark.cn-beijing.volces.com/api/v3/chat/completions" placeholder="https://api.example.com/v1/chat/completions">
                    <div class="form-help">å¡«å…¥æ‚¨çš„å¤§æ¨¡å‹APIæ¥å£åœ°å€</div>
                </div>
                
                <div class="form-group">
                    <label for="apiKey">API å¯†é’¥</label>
                    <input type="password" id="apiKey" value="893b9f2c-3b3c-4943-a482-5ab6dde65007" placeholder="sk-...">
                    <div class="form-help">æ‚¨çš„APIè®¿é—®å¯†é’¥ï¼Œå°†å®‰å…¨å­˜å‚¨åœ¨æœ¬åœ°</div>
                </div>
                
                <div class="form-group">
                    <label for="modelName">æ¨¡å‹åç§°</label>
                    <input type="text" id="modelName" value="doubao-1-5-pro-32k-250115" placeholder="gpt-3.5-turbo">
                    <div class="form-help">ä½¿ç”¨çš„å¤§æ¨¡å‹åç§°</div>
                </div>
                
                <div class="form-group">
                    <label for="systemPrompt">æ•…äº‹ç”Ÿæˆæç¤ºè¯</label>
                    <textarea id="systemPrompt" placeholder="è¯·ä¸ºå„¿ç«¥åˆ›ä½œæ•…äº‹...">ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å„¿ç«¥æ•…äº‹ä½œå®¶ï¼Œæ“…é•¿ä¸º3-8å²çš„å­©å­åˆ›ä½œæ¸©é¦¨ã€æœ‰è¶£ã€å¯Œæœ‰æ•™è‚²æ„ä¹‰çš„æ•…äº‹ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä¸»é¢˜ï¼Œåˆ›ä½œä¸€ä¸ªå®Œæ•´çš„å„¿ç«¥æ•…äº‹ã€‚

è¦æ±‚ï¼š
1. æ•…äº‹è¦åˆ†ä¸º6ä¸ªæ®µè½ï¼Œæ¯ä¸ªæ®µè½100-150å­—
2. è¯­è¨€è¦ç®€å•æ˜“æ‡‚ï¼Œé€‚åˆå„¿ç«¥ç†è§£
3. æƒ…èŠ‚è¦ç”ŸåŠ¨æœ‰è¶£ï¼Œå¯Œæœ‰æƒ³è±¡åŠ›
4. è¦ä¼ é€’æ­£é¢çš„ä»·å€¼è§‚ï¼Œå¦‚å‹‡æ•¢ã€å‹è°Šã€å–„è‰¯ç­‰
5. é¿å…ä»»ä½•å¯èƒ½å“åˆ°å­©å­çš„å†…å®¹
6. ç»“å°¾è¦æ¸©æš–ç§¯æ

è¯·ç›´æ¥è¿”å›æ•…äº‹å†…å®¹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
æ ‡é¢˜ï¼š[æ•…äº‹æ ‡é¢˜]

ç¬¬ä¸€æ®µï¼š[å†…å®¹]
ç¬¬äºŒæ®µï¼š[å†…å®¹]
ç¬¬ä¸‰æ®µï¼š[å†…å®¹]
ç¬¬å››æ®µï¼š[å†…å®¹]
ç¬¬äº”æ®µï¼š[å†…å®¹]
ç¬¬å…­æ®µï¼š[å†…å®¹]</textarea>
                    <div class="form-help">å®šåˆ¶AIç”Ÿæˆæ•…äº‹çš„é£æ ¼å’Œè¦æ±‚</div>
                </div>
                
                <div class="form-group">
                    <button type="button" id="testApiBtn" class="secondary-btn">
                        ğŸ§ª æµ‹è¯•è¿æ¥
                    </button>
                    <button type="submit" class="primary-btn">
                        ğŸ’¾ ä¿å­˜é…ç½®
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>
    
    <script>
        'use strict';

        // AIç»˜æœ¬åº”ç”¨ä¸»ç±»
        class StoryApp {
            constructor() {
                this.currentStory = null;
                this.currentPageIndex = 0;
                this.isPlaying = false;
                this.speechSynthesis = window.speechSynthesis;
                this.currentUtterance = null;
                this.highlightTimeout = null;
                this.loadingInterval = null;
                
                // APIé…ç½®
                this.apiConfig = {
                    url: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
                    key: '893b9f2c-3b3c-4943-a482-5ab6dde65007',
                    model: 'doubao-1-5-pro-32k-250115',
                    systemPrompt: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å„¿ç«¥æ•…äº‹ä½œå®¶ï¼Œæ“…é•¿ä¸º3-8å²çš„å­©å­åˆ›ä½œæ¸©é¦¨ã€æœ‰è¶£ã€å¯Œæœ‰æ•™è‚²æ„ä¹‰çš„æ•…äº‹ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä¸»é¢˜ï¼Œåˆ›ä½œä¸€ä¸ªå®Œæ•´çš„å„¿ç«¥æ•…äº‹ã€‚\n\nè¦æ±‚ï¼š\n1. æ•…äº‹è¦åˆ†ä¸º6ä¸ªæ®µè½ï¼Œæ¯ä¸ªæ®µè½100-150å­—\n2. è¯­è¨€è¦ç®€å•æ˜“æ‡‚ï¼Œé€‚åˆå„¿ç«¥ç†è§£\n3. æƒ…èŠ‚è¦ç”ŸåŠ¨æœ‰è¶£ï¼Œå¯Œæœ‰æƒ³è±¡åŠ›\n4. è¦ä¼ é€’æ­£é¢çš„ä»·å€¼è§‚ï¼Œå¦‚å‹‡æ•¢ã€å‹è°Šã€å–„è‰¯ç­‰\n5. é¿å…ä»»ä½•å¯èƒ½å“åˆ°å­©å­çš„å†…å®¹\n6. ç»“å°¾è¦æ¸©æš–ç§¯æ\n\nè¯·ç›´æ¥è¿”å›æ•…äº‹å†…å®¹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\næ ‡é¢˜ï¼š[æ•…äº‹æ ‡é¢˜]\n\nç¬¬ä¸€æ®µï¼š[å†…å®¹]\nç¬¬äºŒæ®µï¼š[å†…å®¹]\nç¬¬ä¸‰æ®µï¼š[å†…å®¹]\nç¬¬å››æ®µï¼š[å†…å®¹]\nç¬¬äº”æ®µï¼š[å†…å®¹]\nç¬¬å…­æ®µï¼š[å†…å®¹]'
                };
                
                this.init();
            }

            init() {
                console.log('ğŸ¨ AIç»˜æœ¬åº”ç”¨å¯åŠ¨ v3.0 - å¤§æ¨¡å‹ç‰ˆ');
                try {
                    this.loadApiConfig();
                    this.bindEvents();
                    this.showPage('homePage');
                    this.showToast('âœ¨ æ¬¢è¿ä½¿ç”¨AIç»˜æœ¬ï¼å·²é›†æˆå¤§æ¨¡å‹æ•…äº‹ç”Ÿæˆ');
                    this.preloadVoices();
                    this.updateApiStatus();
                } catch (error) {
                    console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showToast('åº”ç”¨åŠ è½½å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }

            loadApiConfig() {
                try {
                    const saved = localStorage.getItem('aiStorybook_apiConfig');
                    if (saved) {
                        this.apiConfig = { ...this.apiConfig, ...JSON.parse(saved) };
                        console.log('ğŸ“¥ å·²åŠ è½½APIé…ç½®');
                    }
                } catch (error) {
                    console.error('âŒ åŠ è½½APIé…ç½®å¤±è´¥:', error);
                }
            }

            saveApiConfig() {
                try {
                    localStorage.setItem('aiStorybook_apiConfig', JSON.stringify(this.apiConfig));
                    console.log('ğŸ’¾ APIé…ç½®å·²ä¿å­˜');
                } catch (error) {
                    console.error('âŒ ä¿å­˜APIé…ç½®å¤±è´¥:', error);
                }
            }

            updateApiStatus() {
                const statusEl = document.getElementById('apiStatus');
                if (!statusEl) return;

                if (this.apiConfig.key && this.apiConfig.url) {
                    statusEl.className = 'api-status success';
                    statusEl.textContent = 'âœ… AIæ¥å£å·²é…ç½®ï¼Œå¯ä»¥ä½¿ç”¨æ™ºèƒ½æ•…äº‹ç”ŸæˆåŠŸèƒ½';
                } else {
                    statusEl.className = 'api-status warning';
                    statusEl.textContent = 'âš ï¸ è¯·é…ç½®AIæ¥å£ä»¥å¯ç”¨æ™ºèƒ½æ•…äº‹ç”ŸæˆåŠŸèƒ½';
                }
            }

            preloadVoices() {
                if (this.speechSynthesis) {
                    this.speechSynthesis.getVoices();
                    this.speechSynthesis.onvoiceschanged = () => {
                        console.log('ğŸµ è¯­éŸ³åº“åŠ è½½å®Œæˆ');
                    };
                }
            }

            bindEvents() {
                // é¦–é¡µäº‹ä»¶
                const generateBtn = document.getElementById('generateBtn');
                const storyInput = document.getElementById('storyInput');
                
                if (generateBtn) {
                    generateBtn.addEventListener('click', () => this.generateStory());
                }

                if (storyInput) {
                    storyInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.generateStory();
                        }
                    });

                    storyInput.addEventListener('focus', () => {
                        storyInput.select();
                    });
                }

                // ä¸»é¢˜æ ‡ç­¾ç‚¹å‡»
                document.querySelectorAll('.theme-tag').forEach(tag => {
                    tag.addEventListener('click', () => {
                        const theme = tag.dataset.theme;
                        if (storyInput) storyInput.value = theme;
                        this.generateStory();
                    });
                });

                // æ•…äº‹é¡µé¢äº‹ä»¶
                const backBtn = document.getElementById('backBtn');
                if (backBtn) {
                    backBtn.addEventListener('click', () => this.goHome());
                }

                const prevBtn = document.getElementById('prevBtn');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => this.previousPage());
                }

                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => this.nextPage());
                }

                const playBtn = document.getElementById('playBtn');
                if (playBtn) {
                    playBtn.addEventListener('click', () => this.togglePlayback());
                }

                const speedSelect = document.getElementById('speedSelect');
                if (speedSelect) {
                    speedSelect.addEventListener('change', () => this.stopPlayback());
                }

                // ç»“æŸé¡µé¢äº‹ä»¶
                const newStoryBtn = document.getElementById('newStoryBtn');
                if (newStoryBtn) {
                    newStoryBtn.addEventListener('click', () => this.goHome());
                }

                const saveStoryBtn = document.getElementById('saveStoryBtn');
                if (saveStoryBtn) {
                    saveStoryBtn.addEventListener('click', () => this.saveStory());
                }

                const shareStoryBtn = document.getElementById('shareStoryBtn');
                if (shareStoryBtn) {
                    shareStoryBtn.addEventListener('click', () => this.shareStory());
                }

                // è®¾ç½®æŒ‰é’® - æ‰“å¼€APIé…ç½®
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => this.showApiConfig());
                }

                // APIé…ç½®æ¨¡æ€æ¡†äº‹ä»¶
                this.bindApiConfigEvents();

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.stopPlayback();
                        this.hideApiConfig();
                    }
                });

                console.log('âœ… æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
            }

            bindApiConfigEvents() {
                const modal = document.getElementById('apiConfigModal');
                const closeBtn = document.getElementById('closeApiConfigBtn');
                const form = document.getElementById('apiConfigForm');
                const testBtn = document.getElementById('testApiBtn');

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideApiConfig());
                }

                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.hideApiConfig();
                        }
                    });
                }

                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveApiConfigFromForm();
                    });
                }

                if (testBtn) {
                    testBtn.addEventListener('click', () => this.testApiConnection());
                }
            }

            showApiConfig() {
                const modal = document.getElementById('apiConfigModal');
                if (!modal) return;

                // å¡«å……å½“å‰é…ç½®
                document.getElementById('apiUrl').value = this.apiConfig.url || '';
                document.getElementById('apiKey').value = this.apiConfig.key || '';
                document.getElementById('modelName').value = this.apiConfig.model || '';
                document.getElementById('systemPrompt').value = this.apiConfig.systemPrompt || '';

                modal.style.display = 'flex';
                this.updateApiStatus();
            }

            hideApiConfig() {
                const modal = document.getElementById('apiConfigModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            saveApiConfigFromForm() {
                this.apiConfig = {
                    url: document.getElementById('apiUrl').value.trim(),
                    key: document.getElementById('apiKey').value.trim(),
                    model: document.getElementById('modelName').value.trim(),
                    systemPrompt: document.getElementById('systemPrompt').value.trim()
                };

                this.saveApiConfig();
                this.updateApiStatus();
                this.hideApiConfig();
                this.showToast('ğŸ’¾ APIé…ç½®å·²ä¿å­˜');
            }

            async testApiConnection() {
                const testBtn = document.getElementById('testApiBtn');
                if (!testBtn) return;

                testBtn.disabled = true;
                testBtn.textContent = 'ğŸ§ª æµ‹è¯•ä¸­...';

                try {
                    const tempConfig = {
                        url: document.getElementById('apiUrl').value.trim(),
                        key: document.getElementById('apiKey').value.trim(),
                        model: document.getElementById('modelName').value.trim(),
                        systemPrompt: document.getElementById('systemPrompt').value.trim()
                    };

                    const response = await this.callAIAPI('æµ‹è¯•è¿æ¥', tempConfig);
                    
                    if (response) {
                        this.showToast('âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼');
                        const statusEl = document.getElementById('apiStatus');
                        if (statusEl) {
                            statusEl.className = 'api-status success';
                            statusEl.textContent = 'âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨';
                        }
                    }
                } catch (error) {
                    console.error('âŒ APIæµ‹è¯•å¤±è´¥:', error);
                    this.showToast('âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message);
                    const statusEl = document.getElementById('apiStatus');
                    if (statusEl) {
                        statusEl.className = 'api-status error';
                        statusEl.textContent = 'âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
                    }
                } finally {
                    testBtn.disabled = false;
                    testBtn.textContent = 'ğŸ§ª æµ‹è¯•è¿æ¥';
                }
            }

            async generateStory() {
                const storyInput = document.getElementById('storyInput');
                const generateBtn = document.getElementById('generateBtn');
                const input = storyInput ? storyInput.value.trim() : '';
                
                if (!input) {
                    this.showToast('â— è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜æˆ–é€‰æ‹©ä¸€ä¸ªé¢„è®¾ä¸»é¢˜');
                    if (storyInput) storyInput.focus();
                    return;
                }

                // æ£€æŸ¥APIé…ç½®
                if (!this.apiConfig.key || !this.apiConfig.url) {
                    this.showToast('âš ï¸ è¯·å…ˆé…ç½®AIæ¥å£æ‰èƒ½ç”Ÿæˆæ•…äº‹');
                    this.showApiConfig();
                    return;
                }

                console.log('ğŸš€ å¼€å§‹AIæ•…äº‹ç”Ÿæˆ:', input);
                
                // ç¦ç”¨ç”ŸæˆæŒ‰é’®
                if (generateBtn) {
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'ğŸ¤– AIåˆ›ä½œä¸­...';
                }

                this.showPage('loadingPage');
                this.animateLoadingSteps();

                try {
                    // ä½¿ç”¨å¤§æ¨¡å‹ç”Ÿæˆæ•…äº‹å†…å®¹
                    const story = await this.createStoryWithAI(input);
                    this.currentStory = story;
                    this.currentPageIndex = 0;

                    // ç”Ÿæˆæ’ç”»
                    await this.generateImages(story);

                    this.showStoryPage();
                    console.log('âœ¨ AIæ•…äº‹ç”Ÿæˆå®Œæˆ:', story.title);
                    this.showToast('ğŸ‰ AIæ•…äº‹åˆ›ä½œå®Œæˆï¼å¯ä»¥å¼€å§‹é˜…è¯»äº†');
                } catch (error) {
                    console.error('âŒ AIæ•…äº‹ç”Ÿæˆå¤±è´¥:', error);
                    this.showToast('ğŸ˜” AIæ•…äº‹ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
                    this.showPage('homePage');
                } finally {
                    // æ¢å¤ç”ŸæˆæŒ‰é’®
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'âœ¨ å¼€å§‹åˆ›ä½œæ•…äº‹';
                    }
                }
            }

            async createStoryWithAI(theme) {
                console.log('ğŸ¤– è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆæ•…äº‹...');
                
                try {
                    const aiResponse = await this.callAIAPI(theme);
                    const story = this.parseAIStoryResponse(aiResponse, theme);
                    
                    if (!story.title || !story.paragraphs || story.paragraphs.length === 0) {
                        throw new Error('AIè¿”å›çš„æ•…äº‹æ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    return story;
                } catch (error) {
                    console.error('âŒ AIæ•…äº‹ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
                    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é¢„è®¾æ¨¡æ¿ä½œä¸ºå¤‡ç”¨
                    return this.createFallbackStory(theme);
                }
            }

            async callAIAPI(userMessage, config = null) {
                const apiConfig = config || this.apiConfig;
                
                const requestBody = {
                    model: apiConfig.model,
                    messages: [
                        {
                            role: "system",
                            content: apiConfig.systemPrompt
                        },
                        {
                            role: "user",
                            content: `è¯·ä¸ºä¸»é¢˜"${userMessage}"åˆ›ä½œä¸€ä¸ªå„¿ç«¥æ•…äº‹ã€‚`
                        }
                    ],
                    temperature: 0.8,
                    max_tokens: 2000
                };

                console.log('ğŸ“¡ å‘é€APIè¯·æ±‚:', {
                    url: apiConfig.url,
                    model: apiConfig.model,
                    theme: userMessage
                });

                const response = await fetch(apiConfig.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('ğŸ“¥ æ”¶åˆ°APIå“åº”:', data);

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®');
                }

                return data.choices[0].message.content;
            }

            parseAIStoryResponse(aiResponse, theme) {
                console.log('ğŸ“ è§£æAIæ•…äº‹å“åº”...');
                
                try {
                    // æå–æ ‡é¢˜
                    let title = theme; // é»˜è®¤æ ‡é¢˜
                    const titleMatch = aiResponse.match(/æ ‡é¢˜[ï¼š:]\s*(.+)/);
                    if (titleMatch) {
                        title = titleMatch[1].trim();
                    }

                    // æå–æ®µè½
                    const paragraphs = [];
                    const paragraphRegex = /ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+æ®µ[ï¼š:]\s*(.+?)(?=ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+æ®µ[ï¼š:]|$)/gs;
                    let match;
                    
                    while ((match = paragraphRegex.exec(aiResponse)) !== null) {
                        const paragraph = match[1].trim();
                        if (paragraph) {
                            paragraphs.push(paragraph);
                        }
                    }

                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†æ ¼å¼ï¼Œå°è¯•æŒ‰æ®µè½åˆ†å‰²
                    if (paragraphs.length === 0) {
                        const lines = aiResponse.split('\n').filter(line => line.trim() && !line.includes('æ ‡é¢˜'));
                        for (const line of lines) {
                            const cleaned = line.trim();
                            if (cleaned.length > 50) { // è¿‡æ»¤å¤ªçŸ­çš„è¡Œ
                                paragraphs.push(cleaned);
                            }
                        }
                    }

                    // ç¡®ä¿è‡³å°‘æœ‰4ä¸ªæ®µè½
                    if (paragraphs.length < 4) {
                        console.warn('âš ï¸ AIç”Ÿæˆçš„æ®µè½æ•°é‡ä¸è¶³ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                        return this.createFallbackStory(theme);
                    }

                    console.log('âœ… æ•…äº‹è§£æå®Œæˆ:', { title, paragraphs: paragraphs.length });
                    
                    return {
                        title,
                        paragraphs: paragraphs.slice(0, 8), // æœ€å¤š8ä¸ªæ®µè½
                        source: 'ai-generated'
                    };
                } catch (error) {
                    console.error('âŒ è§£æAIå“åº”å¤±è´¥:', error);
                    throw new Error('è§£æAIæ•…äº‹å¤±è´¥');
                }
            }

            createFallbackStory(theme) {
                console.log('ğŸ“š ä½¿ç”¨é¢„è®¾æ•…äº‹æ¨¡æ¿');
                
                const fallbackStories = {
                    'å‹‡æ•¢çš„å°åŠ¨ç‰©': {
                        title: 'å‹‡æ•¢çš„å°å…”å­è´è´',
                        paragraphs: [
                            'åœ¨ä¸€ç‰‡ç¾ä¸½çš„æ£®æ—é‡Œï¼Œä½ç€ä¸€åªåå«è´è´çš„å°å…”å­ã€‚è´è´æœ‰ç€é›ªç™½çš„æ¯›å‘å’Œçº¢å®çŸ³èˆ¬çš„çœ¼ç›ï¼Œä½†å¥¹æ€»æ˜¯å¾ˆèƒ†å°ï¼Œä¸æ•¢ç‹¬è‡ªå‡ºé—¨æ¢é™©ã€‚',
                            'ä¸€å¤©ï¼Œæ£®æ—é‡Œä¼ æ¥äº†æ±‚æ•‘å£°ã€‚åŸæ¥æ˜¯å°æ¾é¼ å¥‡å¥‡æ‰è¿›äº†æ·±æ·±çš„å±±æ´é‡Œï¼Œå¤§å®¶éƒ½ä¸çŸ¥é“è¯¥æ€ä¹ˆåŠã€‚åŠ¨ç‰©ä»¬å›´åœ¨æ´å£ï¼Œç„¦æ€¥åœ°è®¨è®ºç€æ•‘æ´æ–¹æ¡ˆã€‚',
                            'è´è´çœ‹åˆ°å¤§å®¶éƒ½å¾ˆç€æ€¥ï¼Œå¿ƒé‡Œä¹Ÿå¾ˆéš¾è¿‡ã€‚è™½ç„¶å¥¹å¾ˆå®³æ€•ï¼Œä½†å¥¹æƒ³èµ·äº†å¦ˆå¦ˆè¯´è¿‡çš„è¯ï¼š"çœŸæ­£çš„å‹‡æ•¢ä¸æ˜¯ä¸å®³æ€•ï¼Œè€Œæ˜¯å³ä½¿å®³æ€•ä¹Ÿè¦å»å¸®åŠ©åˆ«äººã€‚"',
                            'è´è´æ·±æ·±å¸äº†ä¸€å£æ°”ï¼Œå‹‡æ•¢åœ°è·³è¿›äº†å±±æ´ã€‚æ´é‡Œå¾ˆé»‘ï¼Œå¥¹çš„å¿ƒæ€¦æ€¦ç›´è·³ï¼Œä½†å¥¹æƒ³ç€å¥‡å¥‡éœ€è¦å¸®åŠ©ï¼Œå°±ä¸€æ­¥ä¸€æ­¥å°å¿ƒåœ°å¾€ä¸‹èµ°ã€‚',
                            'ç»ˆäºï¼Œè´è´æ‰¾åˆ°äº†å—ä¼¤çš„å¥‡å¥‡ã€‚å¥¹æ¸©æŸ”åœ°å®‰æ…°å¥‡å¥‡ï¼Œç„¶åèƒŒç€ä»–æ…¢æ…¢çˆ¬å‡ºäº†å±±æ´ã€‚å½“å¤§å®¶çœ‹åˆ°è´è´å®‰å…¨åœ°æ•‘å‡ºå¥‡å¥‡æ—¶ï¼Œéƒ½ä¸ºå¥¹é¼“æŒå–å½©ã€‚',
                            'ä»é‚£å¤©èµ·ï¼Œè´è´å†ä¹Ÿä¸æ˜¯é‚£åªèƒ†å°çš„å°å…”å­äº†ã€‚å¥¹å­¦ä¼šäº†å‹‡æ•¢ï¼Œä¹Ÿæ˜ç™½äº†å¸®åŠ©åˆ«äººä¼šè®©è‡ªå·±å˜å¾—æ›´åŠ å¼ºå¤§å’Œå¿«ä¹ã€‚'
                        ]
                    }
                };

                // è¿”å›åŒ¹é…çš„æ•…äº‹æˆ–ç”Ÿæˆç®€å•æ•…äº‹
                return fallbackStories[theme] || {
                    title: `${theme}çš„æ•…äº‹`,
                    paragraphs: [
                        `è¿™æ˜¯ä¸€ä¸ªå…³äº${theme}çš„ç¾å¦™æ•…äº‹ã€‚åœ¨ä¸€ä¸ªå……æ»¡å¥‡è¿¹çš„ä¸–ç•Œé‡Œï¼Œæˆ‘ä»¬çš„ä¸»äººå…¬å³å°†å¼€å§‹ä¸€æ®µéš¾å¿˜çš„å†’é™©æ—…ç¨‹ã€‚`,
                        `ä¸»äººå…¬é‡åˆ°äº†å„ç§æœ‰è¶£çš„æŒ‘æˆ˜å’Œæœ‹å‹ï¼Œæ¯ä¸€æ¬¡ç»å†éƒ½è®©ä»–å­¦åˆ°äº†çè´µçš„äººç”Ÿç»éªŒï¼Œå˜å¾—æ›´åŠ å‹‡æ•¢å’Œæ™ºæ…§ã€‚`,
                        `é€šè¿‡åŠªåŠ›å’ŒåšæŒï¼Œä¸»äººå…¬ä¸ä»…å¸®åŠ©äº†è®¸å¤šéœ€è¦å¸®åŠ©çš„äººï¼Œä¹Ÿå‘ç°äº†è‡ªå·±å†…å¿ƒæ·±å¤„çš„åŠ›é‡å’Œç¾å¥½å“è´¨ã€‚`,
                        `æœ€ç»ˆï¼Œè¿™ä¸ªå…³äº${theme}çš„æ•…äº‹å‘Šè¯‰æˆ‘ä»¬ï¼Œåªè¦ä¿æŒå–„è‰¯çš„å¿ƒå’Œå‹‡æ•¢çš„ç²¾ç¥ï¼Œå°±èƒ½åˆ›é€ å±äºè‡ªå·±çš„ç²¾å½©äººç”Ÿã€‚`
                    ],
                    source: 'fallback'
                };
            }

            async generateImages(story) {
                if (!story) return;
                
                story.images = [];
                
                // é«˜è´¨é‡å›¾ç‰‡åº“ï¼Œæ ¹æ®å†…å®¹åŒ¹é…
                const imageLibrary = {
                    'å…”å­': [
                        'https://images.unsplash.com/photo-1585110396000-c9ffd4e4b308?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1425082661705-1834bfd09dca?w=400&h=300&fit=crop&q=80'
                    ],
                    'æ£®æ—': [
                        'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop&q=80'
                    ],
                    'å‹è°Š': [
                        'https://images.unsplash.com/photo-1529903475582-154eb4c7ee9a?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1523800503107-5bc3ba2a6f81?w=400&h=300&fit=crop&q=80'
                    ],
                    'æµ·åº•': [
                        'https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=400&h=300&fit=crop&q=80'
                    ],
                    'å¤ªç©º': [
                        'https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=400&h=300&fit=crop&q=80'
                    ],
                    'å…¬ä¸»': [
                        'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop&q=80'
                    ],
                    'èŠ±å›­': [
                        'https://images.unsplash.com/photo-1492571350019-22de08371fd3?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400&h=300&fit=crop&q=80'
                    ],
                    'å†’é™©': [
                        'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=400&h=300&fit=crop&q=80',
                        'https://images.unsplash.com/photo-1506197603052-3cc9c3a201bd?w=400&h=300&fit=crop&q=80'
                    ]
                };

                // é»˜è®¤å›¾ç‰‡
                const defaultImages = [
                    'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1529655683826-aba9b3e77383?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=300&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop&q=80'
                ];

                for (let i = 0; i < story.paragraphs.length; i++) {
                    let selectedImages = defaultImages;
                    
                    // æ ¹æ®æ®µè½å†…å®¹å’Œæ•…äº‹æ ‡é¢˜é€‰æ‹©åˆé€‚çš„å›¾ç‰‡
                    const content = (story.paragraphs[i] + ' ' + story.title).toLowerCase();
                    
                    for (const [keyword, images] of Object.entries(imageLibrary)) {
                        if (content.includes(keyword) || content.includes(keyword.toLowerCase())) {
                            selectedImages = images;
                            break;
                        }
                    }
                    
                    // é€‰æ‹©å›¾ç‰‡å¹¶æ·»åŠ åˆ°æ•…äº‹ä¸­
                    const imageIndex = i % selectedImages.length;
                    story.images.push(selectedImages[imageIndex]);
                    
                    await this.delay(200 + Math.random() * 300);
                }

                console.log('ğŸ¨ æ•…äº‹æ’ç”»ç”Ÿæˆå®Œæˆï¼Œå…±', story.images.length, 'å¼ ');
            }

            animateLoadingSteps() {
                const steps = ['step1', 'step2', 'step3'];
                let currentStep = 0;

                this.loadingInterval = setInterval(() => {
                    if (currentStep < steps.length) {
                        const stepElement = document.getElementById(steps[currentStep]);
                        if (stepElement) {
                            stepElement.classList.add('active');
                        }
                        currentStep++;
                    } else {
                        clearInterval(this.loadingInterval);
                        this.loadingInterval = null;
                    }
                }, 1000);
            }

            showStoryPage() {
                this.showPage('storyPage');
                this.updateStoryDisplay();
            }

            updateStoryDisplay() {
                if (!this.currentStory) return;

                const storyTitle = document.getElementById('storyTitle');
                const currentPage = document.getElementById('currentPage');
                const totalPages = document.getElementById('totalPages');
                const storyParagraph = document.getElementById('storyParagraph');

                if (storyTitle) storyTitle.textContent = this.currentStory.title;
                if (currentPage) currentPage.textContent = this.currentPageIndex + 1;
                if (totalPages) totalPages.textContent = this.currentStory.paragraphs.length;
                if (storyParagraph) storyParagraph.textContent = this.currentStory.paragraphs[this.currentPageIndex];
                
                // æ›´æ–°å›¾ç‰‡
                this.updateStoryImage();
                
                // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                if (prevBtn) prevBtn.disabled = this.currentPageIndex === 0;
                if (nextBtn) {
                    nextBtn.textContent = this.currentPageIndex === this.currentStory.paragraphs.length - 1 ? 'ç»“æŸ â†’' : 'ä¸‹ä¸€é¡µ â†’';
                }
                
                // åœæ­¢å½“å‰æ’­æ”¾
                this.stopPlayback();
            }

            updateStoryImage() {
                const img = document.getElementById('storyImg');
                const loading = document.getElementById('imageLoading');
                
                if (!img || !loading || !this.currentStory?.images) return;
                
                const imageUrl = this.currentStory.images[this.currentPageIndex];
                if (imageUrl) {
                    loading.style.display = 'flex';
                    img.style.display = 'none';
                    
                    img.onload = () => {
                        loading.style.display = 'none';
                        img.style.display = 'block';
                    };
                    
                    img.onerror = () => {
                        loading.style.display = 'none';
                        img.style.display = 'block';
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjQwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiNGNUY1RjUiLz48cGF0aCBkPSJNMTc1IDEyNUwyMjUgMTc1TDI3NSAxMjVIMzI1TDI3NSA3NUwyMjUgMTI1TDE3NSA3NUgxMjVMMTc1IDEyNVoiIGZpbGw9IiNEMUQxRDEiLz48L3N2Zz4=';
                    };
                    
                    img.src = imageUrl;
                    img.alt = `AIç”Ÿæˆæ•…äº‹æ’ç”» - ç¬¬${this.currentPageIndex + 1}é¡µ`;
                }
            }

            previousPage() {
                if (this.currentPageIndex > 0) {
                    this.currentPageIndex--;
                    this.updateStoryDisplay();
                    this.showToast(`ğŸ“– ç¬¬ ${this.currentPageIndex + 1} é¡µ`);
                }
            }

            nextPage() {
                if (this.currentPageIndex < this.currentStory.paragraphs.length - 1) {
                    this.currentPageIndex++;
                    this.updateStoryDisplay();
                    this.showToast(`ğŸ“– ç¬¬ ${this.currentPageIndex + 1} é¡µ`);
                } else {
                    this.showPage('endPage');
                    this.showToast('ğŸ‰ AIæ•…äº‹è¯»å®Œäº†ï¼å¸Œæœ›ä½ å–œæ¬¢');
                }
            }

            togglePlayback() {
                if (this.isPlaying) {
                    this.stopPlayback();
                } else {
                    this.startPlayback();
                }
            }

            startPlayback() {
                if (!this.currentStory || !this.speechSynthesis) {
                    this.showToast('âŒ è¯­éŸ³åŠŸèƒ½æš‚ä¸å¯ç”¨');
                    return;
                }

                const text = this.currentStory.paragraphs[this.currentPageIndex];
                const speedSelect = document.getElementById('speedSelect');
                const speed = speedSelect ? parseFloat(speedSelect.value) : 1.0;

                this.currentUtterance = new SpeechSynthesisUtterance(text);
                this.currentUtterance.rate = speed;
                this.currentUtterance.pitch = 1.1;
                this.currentUtterance.volume = 1;

                const voices = this.speechSynthesis.getVoices();
                const chineseVoice = voices.find(voice => 
                    voice.lang.includes('zh') || 
                    voice.lang.includes('CN') ||
                    voice.name.includes('Chinese')
                );
                if (chineseVoice) {
                    this.currentUtterance.voice = chineseVoice;
                }

                this.currentUtterance.onstart = () => {
                    this.isPlaying = true;
                    this.updatePlayButton();
                    this.startTextHighlight(text);
                    console.log('ğŸµ å¼€å§‹è¯­éŸ³æœ—è¯»');
                };

                this.currentUtterance.onend = () => {
                    this.isPlaying = false;
                    this.updatePlayButton();
                    this.clearTextHighlight();
                    console.log('â¹ï¸ è¯­éŸ³æœ—è¯»ç»“æŸ');
                };

                this.currentUtterance.onerror = (error) => {
                    this.isPlaying = false;
                    this.updatePlayButton();
                    this.showToast('ğŸ˜” è¯­éŸ³æ’­æ”¾å‡ºé”™ï¼Œè¯·é‡è¯•');
                    console.error('âŒ TTSé”™è¯¯:', error);
                };

                try {
                    this.speechSynthesis.speak(this.currentUtterance);
                    this.showToast('ğŸµ å¼€å§‹æœ—è¯»AIæ•…äº‹');
                } catch (error) {
                    console.error('âŒ è¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
                    this.showToast('âŒ è¯­éŸ³åŠŸèƒ½æš‚ä¸å¯ç”¨');
                }
            }

            stopPlayback() {
                if (this.speechSynthesis) {
                    this.speechSynthesis.cancel();
                }
                this.isPlaying = false;
                this.updatePlayButton();
                this.clearTextHighlight();
            }

            updatePlayButton() {
                const playBtn = document.getElementById('playBtn');
                if (playBtn) {
                    playBtn.textContent = this.isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
                    playBtn.title = this.isPlaying ? 'æš‚åœæœ—è¯»' : 'æ’­æ”¾æœ—è¯»';
                }
            }

            startTextHighlight(text) {
                this.clearTextHighlight();
                
                const paragraph = document.getElementById('storyParagraph');
                if (!paragraph || !text) return;

                const chars = text.split('');
                let currentIndex = 0;
                
                const highlightInterval = setInterval(() => {
                    if (currentIndex < chars.length && this.isPlaying) {
                        this.highlightCharacter(paragraph, currentIndex, text);
                        currentIndex++;
                    } else {
                        clearInterval(highlightInterval);
                    }
                }, 120);
                
                this.highlightTimeout = highlightInterval;
            }

            highlightCharacter(paragraph, index, originalText) {
                if (!paragraph || !originalText) return;

                const beforeText = originalText.substring(0, index);
                const currentChar = originalText.charAt(index);
                const afterText = originalText.substring(index + 1);
                
                paragraph.innerHTML = beforeText + 
                                     `<span class="highlight">${currentChar}</span>` + 
                                     afterText;
            }

            clearTextHighlight() {
                if (this.highlightTimeout) {
                    clearInterval(this.highlightTimeout);
                    this.highlightTimeout = null;
                }
                
                const paragraph = document.getElementById('storyParagraph');
                if (paragraph && this.currentStory) {
                    paragraph.textContent = this.currentStory.paragraphs[this.currentPageIndex] || '';
                }
            }

            saveStory() {
                if (!this.currentStory) {
                    this.showToast('âŒ æ²¡æœ‰æ•…äº‹å¯ä»¥ä¿å­˜');
                    return;
                }
                
                try {
                    const savedStories = JSON.parse(localStorage.getItem('savedStories') || '[]');
                    const storyToSave = {
                        ...this.currentStory,
                        savedAt: new Date().toISOString(),
                        id: Date.now()
                    };
                    
                    savedStories.push(storyToSave);
                    localStorage.setItem('savedStories', JSON.stringify(savedStories));
                    
                    const sourceText = this.currentStory.source === 'ai-generated' ? 'AIç”Ÿæˆçš„' : '';
                    this.showToast(`ğŸ’¾ ${sourceText}æ•…äº‹å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼`);
                    console.log('ğŸ’¾ æ•…äº‹ä¿å­˜æˆåŠŸ:', storyToSave.title);
                } catch (error) {
                    console.error('âŒ ä¿å­˜æ•…äº‹å¤±è´¥:', error);
                    this.showToast('ğŸ˜” ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
                }
            }

            shareStory() {
                if (!this.currentStory) {
                    this.showToast('âŒ æ²¡æœ‰æ•…äº‹å¯ä»¥åˆ†äº«');
                    return;
                }
                
                const aiLabel = this.currentStory.source === 'ai-generated' ? 'AIåˆ›ä½œçš„' : '';
                const shareText = `æˆ‘åœ¨AIç»˜æœ¬åˆ›å»ºäº†ä¸€ä¸ªç²¾å½©çš„${aiLabel}æ•…äº‹ï¼šã€Š${this.currentStory.title}ã€‹\n\nè¿™æ˜¯ä¸€ä¸ªé›†æˆäº†å¤§æ¨¡å‹AIçš„å„¿ç«¥ç»˜æœ¬åˆ›ä½œå·¥å…·ï¼Œæ”¯æŒæ™ºèƒ½æ•…äº‹ç”Ÿæˆã€æ’ç”»é…å›¾å’Œè¯­éŸ³æœ—è¯»ã€‚å¿«æ¥ä¸€èµ·åˆ›ä½œå±äºä½ çš„æ•…äº‹å§ï¼\n\nâœ¨ ç‰¹è‰²åŠŸèƒ½ï¼š\nğŸ¤– å¤§æ¨¡å‹AIæ™ºèƒ½æ•…äº‹åˆ›ä½œ\nğŸ¨ ç²¾ç¾æ’ç”»è‡ªåŠ¨é…å›¾\nğŸµ è¯­éŸ³æœ—è¯»è·Ÿè¯»ä½“éªŒ\nğŸ“± ç§»åŠ¨ç«¯å®Œç¾é€‚é…\nğŸ’¾ æœ¬åœ°æ•…äº‹ä¿å­˜ç®¡ç†`;
                
                if (navigator.share) {
                    navigator.share({
                        title: `AIç»˜æœ¬ - ${this.currentStory.title}`,
                        text: shareText,
                        url: window.location.href
                    }).then(() => {
                        this.showToast('ğŸ“¤ åˆ†äº«æˆåŠŸï¼');
                    }).catch((error) => {
                        console.log('åˆ†äº«å–æ¶ˆæˆ–å¤±è´¥:', error);
                        this.fallbackShare(shareText);
                    });
                } else {
                    this.fallbackShare(shareText);
                }
            }

            fallbackShare(text) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showToast('ğŸ“‹ åˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                    }).catch(() => {
                        this.showManualShare(text);
                    });
                } else {
                    this.showManualShare(text);
                }
            }

            showManualShare(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    this.showToast('ğŸ“‹ åˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶ï¼');
                } catch (err) {
                    this.showToast('ğŸ’¡ è¯·æ‰‹åŠ¨å¤åˆ¶åˆ†äº«æ–‡æ¡ˆ');
                    console.log('åˆ†äº«å†…å®¹:', text);
                }
                
                document.body.removeChild(textArea);
            }

            goHome() {
                this.stopPlayback();
                this.currentStory = null;
                this.currentPageIndex = 0;
                
                const storyInput = document.getElementById('storyInput');
                if (storyInput) {
                    storyInput.value = '';
                    storyInput.focus();
                }
                
                this.showPage('homePage');
                this.showToast('ğŸ  æ¬¢è¿å›åˆ°é¦–é¡µï¼Œå¼€å§‹æ–°çš„AIæ•…äº‹åˆ›ä½œå§ï¼');
            }

            showPage(pageId) {
                if (this.loadingInterval) {
                    clearInterval(this.loadingInterval);
                    this.loadingInterval = null;
                }

                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('active');
                });

                document.querySelectorAll('.page').forEach(page => {
                    page.style.display = 'none';
                });
                
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.style.display = 'flex';
                    console.log('ğŸ“„ åˆ‡æ¢åˆ°é¡µé¢:', pageId);
                }
            }

            showToast(message, duration = 3000) {
                console.log('ğŸ“¢', message);
                const toast = document.getElementById('toast');
                if (!toast) return;

                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            destroy() {
                this.stopPlayback();
                if (this.loadingInterval) {
                    clearInterval(this.loadingInterval);
                }
                if (this.highlightTimeout) {
                    clearInterval(this.highlightTimeout);
                }
            }
        }

        // åº”ç”¨åˆå§‹åŒ–
        let storyApp = null;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¯ DOMå†…å®¹åŠ è½½å®Œæˆ');
            storyApp = new StoryApp();
        });

        window.addEventListener('beforeunload', () => {
            if (storyApp) {
                storyApp.destroy();
            }
        });

        // é˜²æ­¢é¡µé¢ç¼©æ”¾å’ŒåŒå‡»
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = new Date().getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        document.addEventListener('contextmenu', function(event) {
            event.preventDefault();
        });

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (error) => {
            console.error('ğŸš¨ å…¨å±€é”™è¯¯:', error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('ğŸš¨ æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
        });

        console.log('ğŸ‰ AIç»˜æœ¬åº”ç”¨è„šæœ¬åŠ è½½å®Œæˆ - å¤§æ¨¡å‹ç‰ˆæœ¬');
    </script>
</body>
</html>